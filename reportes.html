<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIMGECA — Reportes de Mantenimiento</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --azul:       #003B8E;
      --azul-mid:   #0057CC;
      --azul-light: #1A75FF;
      --azul-pale:  #E8F0FE;
      --accent:     #00C2A8;
      --danger:     #EF4444;
      --success:    #10B981;
      --warning:    #F59E0B;
      --bg:         #F0F4FA;
      --surface:    #FFFFFF;
      --surface2:   #F8FAFF;
      --text:       #0D1B3E;
      --text-mid:   #3D5280;
      --text-light: #7A90B8;
      --border:     #DDE5F4;
      --sidebar-w:  265px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }

    /* ══ PRELOADER ══ */
    #simgeca-preloader {
      position: fixed; inset: 0; z-index: 9999;
      background: #003B8E;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 1.5rem;
      transition: opacity .5s ease, visibility .5s ease;
    }
    #simgeca-preloader.fade-out { opacity: 0; visibility: hidden; }
    .pre-logo { display: flex; flex-direction: column; align-items: center; gap: .6rem; }
    .pre-icon { width: 64px; height: 64px; background: rgba(255,255,255,.1); border: 1.5px solid rgba(255,255,255,.2); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; color: #00C2A8; animation: pre-pulse 1.8s ease-in-out infinite; }
    .pre-title { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 800; color: #fff; letter-spacing: -.5px; }
    .pre-sub { font-size: .68rem; color: rgba(255,255,255,.35); text-transform: uppercase; letter-spacing: .1em; }
    .pre-bar-wrap { width: 180px; height: 3px; background: rgba(255,255,255,.12); border-radius: 99px; overflow: hidden; }
    .pre-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #00C2A8, #1A75FF); border-radius: 99px; animation: pre-load 1.6s cubic-bezier(.4,0,.2,1) forwards; }
    @keyframes pre-load { 0%{width:0%} 60%{width:75%} 100%{width:100%} }
    @keyframes pre-pulse { 0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,194,168,.3)} 50%{transform:scale(1.06);box-shadow:0 0 0 12px rgba(0,194,168,0)} }

    /* ══ SIDEBAR ══ */
    .sidebar { width: var(--sidebar-w); background: var(--azul); min-height: 100vh; display: flex; flex-direction: column; position: fixed; top: 0; left: 0; z-index: 100; }
    .sidebar-logo { padding: 1.5rem 1.25rem 1.1rem; border-bottom: 1px solid rgba(255,255,255,.08); }
    .logo-row { display: flex; align-items: center; gap: .7rem; }
    .logo-icon { width: 38px; height: 38px; background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.18); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--accent); }
    .logo-text { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: -.5px; }
    .logo-sub  { font-size: .62rem; color: rgba(255,255,255,.35); margin-top: .1rem; }
    .sidebar-nav { flex: 1; padding: .75rem 0; overflow-y: auto; }
    .nav-section { font-size: .6rem; font-weight: 700; color: rgba(255,255,255,.28); text-transform: uppercase; letter-spacing: .1em; padding: .85rem 1.25rem .3rem; }
    .nav-item { display: flex; align-items: center; gap: .7rem; padding: .65rem 1.25rem; color: rgba(255,255,255,.55); font-size: .85rem; font-weight: 500; cursor: pointer; transition: all .2s; border-left: 3px solid transparent; text-decoration: none; }
    .nav-item:hover { background: rgba(255,255,255,.06); color: rgba(255,255,255,.9); }
    .nav-item.active { background: rgba(255,255,255,.1); color: #fff; border-left-color: var(--accent); }
    .nav-item i { width: 17px; text-align: center; font-size: .9rem; }
    .nav-badge { margin-left: auto; background: var(--danger); color: #fff; font-size: .62rem; font-weight: 700; padding: .12rem .42rem; border-radius: 20px; display: none; }
    .sidebar-footer { padding: .9rem 1.25rem; border-top: 1px solid rgba(255,255,255,.08); }
    .user-card { display: flex; align-items: center; gap: .65rem; }
    .user-avatar { width: 34px; height: 34px; background: var(--accent); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: .85rem; color: #fff; font-weight: 700; flex-shrink: 0; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: .8rem; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: .68rem; color: rgba(255,255,255,.38); }
    .btn-logout { background: none; border: none; cursor: pointer; color: rgba(255,255,255,.35); font-size: .88rem; padding: .25rem; border-radius: 6px; transition: color .2s; }
    .btn-logout:hover { color: var(--danger); }

    /* ══ MAIN ══ */
    .main { margin-left: var(--sidebar-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: .9rem 1.75rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
    .topbar-left h1 { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--text); }
    .topbar-left p  { font-size: .75rem; color: var(--text-light); margin-top: .05rem; }
    .topbar-right   { display: flex; align-items: center; gap: .6rem; }
    .btn-primary { display: flex; align-items: center; gap: .5rem; padding: .55rem 1.1rem; background: var(--azul); color: #fff; border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; cursor: pointer; transition: background .2s; }
    .btn-primary:hover { background: var(--azul-mid); }

    .page-content { padding: 1.5rem 1.75rem; flex: 1; }

    /* ══ KPI CARDS ══ */
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .kpi-card { background: var(--surface); border: 1.5px solid var(--border); border-radius: 14px; padding: 1.1rem 1.25rem; display: flex; align-items: center; gap: 1rem; }
    .kpi-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .kpi-icon.pending  { background: #FEF3C7; color: var(--warning); }
    .kpi-icon.process  { background: #EEF3FF; color: var(--azul-light); }
    .kpi-icon.resolved { background: #D1FAE5; color: var(--success); }
    .kpi-icon.total    { background: var(--azul-pale); color: var(--azul); }
    .kpi-val { font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 800; color: var(--text); line-height: 1; }
    .kpi-lbl { font-size: .72rem; color: var(--text-light); margin-top: .2rem; }

    /* ══ TABS ══ */
    .tabs { display: flex; gap: .35rem; margin-bottom: 1.25rem; background: var(--surface); border: 1.5px solid var(--border); border-radius: 11px; padding: .3rem; width: fit-content; }
    .tab { padding: .45rem 1.1rem; border-radius: 8px; font-size: .83rem; font-weight: 600; cursor: pointer; color: var(--text-light); transition: all .2s; border: none; background: none; font-family: 'DM Sans', sans-serif; display: flex; align-items: center; gap: .45rem; }
    .tab.active { background: var(--azul); color: #fff; }
    .tab:hover:not(.active) { background: var(--azul-pale); color: var(--azul); }
    .tab-count { font-size: .7rem; opacity: .7; }

    /* ══ TOOLBAR ══ */
    .toolbar { display: flex; align-items: center; gap: .75rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .search-wrap { position: relative; flex: 1; min-width: 220px; max-width: 340px; }
    .search-wrap i { position: absolute; left: 11px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: .85rem; pointer-events: none; }
    .search-input { width: 100%; padding: .6rem 1rem .6rem 2.35rem; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface); font-family: 'DM Sans', sans-serif; font-size: .85rem; color: var(--text); outline: none; transition: border-color .2s; }
    .search-input:focus { border-color: var(--azul-light); }
    .filter-select { padding: .6rem .9rem; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface); font-family: 'DM Sans', sans-serif; font-size: .83rem; color: var(--text-mid); outline: none; cursor: pointer; }
    .count-badge { margin-left: auto; font-size: .78rem; color: var(--text-light); font-weight: 500; }

    /* ══ REPORTES LIST ══ */
    .reporte-list { display: flex; flex-direction: column; gap: .75rem; }

    .reporte-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      transition: box-shadow .2s, transform .2s;
      animation: fadeIn .3s ease both;
      cursor: pointer;
    }
    .reporte-card:hover { box-shadow: 0 6px 24px rgba(0,59,142,.09); transform: translateY(-1px); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

    .reporte-bar { height: 4px; }
    .bar-pendiente { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
    .bar-en_proceso { background: linear-gradient(90deg, #1A75FF, #60A5FA); }
    .bar-resuelto  { background: linear-gradient(90deg, #10B981, #34D399); }

    .reporte-body { padding: 1rem 1.25rem; display: flex; align-items: flex-start; gap: 1rem; }
    .reporte-icon-wrap { width: 46px; height: 46px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.15rem; flex-shrink: 0; }
    .icon-pendiente  { background: #FEF3C7; color: var(--warning); }
    .icon-en_proceso { background: #EEF3FF; color: var(--azul-light); }
    .icon-resuelto   { background: #D1FAE5; color: var(--success); }

    .reporte-main { flex: 1; min-width: 0; }
    .reporte-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; margin-bottom: .4rem; }
    .reporte-titulo { font-family: 'Syne', sans-serif; font-size: .98rem; font-weight: 700; color: var(--text); }
    .estado-badge { font-size: .68rem; font-weight: 700; padding: .22rem .65rem; border-radius: 6px; white-space: nowrap; flex-shrink: 0; }
    .badge-pendiente  { background: #FEF3C7; color: #92400E; }
    .badge-en_proceso { background: #EEF3FF; color: var(--azul); }
    .badge-resuelto   { background: #D1FAE5; color: #065F46; }

    .reporte-desc { font-size: .82rem; color: var(--text-mid); line-height: 1.5; margin-bottom: .6rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .reporte-meta { display: flex; flex-wrap: wrap; gap: .5rem 1.2rem; }
    .meta-item { display: flex; align-items: center; gap: .35rem; font-size: .73rem; color: var(--text-light); }
    .meta-item i { font-size: .68rem; }

    .reporte-footer { padding: .65rem 1.25rem; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--surface2); }
    .reporte-footer-left { display: flex; align-items: center; gap: .4rem; font-size: .74rem; color: var(--text-light); }
    .btn-ver { display: flex; align-items: center; gap: .35rem; padding: .32rem .8rem; border: 1.5px solid var(--border); border-radius: 7px; font-size: .75rem; font-weight: 600; background: var(--surface); color: var(--text-mid); cursor: pointer; transition: all .15s; font-family: 'DM Sans', sans-serif; }
    .btn-ver:hover { border-color: var(--azul-light); color: var(--azul); background: var(--azul-pale); }

    /* ══ EMPTY STATE ══ */
    .empty-state { text-align: center; padding: 4rem 1rem; color: var(--text-light); }
    .empty-state i { font-size: 2.5rem; margin-bottom: .75rem; display: block; opacity: .3; }
    .empty-state h3 { font-family: 'Syne', sans-serif; font-size: 1.1rem; color: var(--text-mid); margin-bottom: .4rem; }
    .empty-state p { font-size: .83rem; }

    /* ══ MODAL DETALLE ══ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(13,27,62,.45); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border-radius: 18px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,.2); animation: modalIn .25s ease; }
    @keyframes modalIn { from { opacity:0; transform:scale(.96) translateY(12px); } to { opacity:1; transform:none; } }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-family: 'Syne', sans-serif; font-size: 1.05rem; font-weight: 700; color: var(--text); }
    .modal-close { width: 32px; height: 32px; border: none; background: var(--surface2); border-radius: 8px; cursor: pointer; color: var(--text-light); font-size: .9rem; display: flex; align-items: center; justify-content: center; transition: all .15s; }
    .modal-close:hover { background: #FEE2E2; color: var(--danger); }
    .modal-body { padding: 1.25rem 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: .6rem; flex-wrap: wrap; }

    /* Detalle reporte en modal */
    .det-section { margin-bottom: 1.25rem; }
    .det-label { font-size: .68rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .08em; margin-bottom: .45rem; padding-bottom: .35rem; border-bottom: 1px solid var(--border); }
    .det-value { font-size: .88rem; color: var(--text-mid); line-height: 1.6; }
    .det-value strong { color: var(--text); }

    .det-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .9rem; margin-bottom: 1.25rem; }
    .det-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: .75rem 1rem; }
    .det-item-lbl { font-size: .67rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .05em; }
    .det-item-val { font-size: .88rem; font-weight: 600; color: var(--text); margin-top: .25rem; }

    .desc-box { background: var(--surface2); border: 1.5px solid var(--border); border-radius: 10px; padding: 1rem; font-size: .86rem; color: var(--text-mid); line-height: 1.65; margin-bottom: 1.25rem; }

    /* Estado selector en modal */
    .estado-selector { display: flex; gap: .5rem; flex-wrap: wrap; }
    .estado-btn { padding: .45rem 1rem; border-radius: 8px; font-size: .8rem; font-weight: 600; cursor: pointer; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text-mid); font-family: 'DM Sans', sans-serif; transition: all .2s; }
    .estado-btn:hover { border-color: var(--azul-light); }
    .estado-btn.sel-pendiente  { background: #FEF3C7; border-color: #FCD34D; color: #92400E; }
    .estado-btn.sel-en_proceso { background: #EEF3FF; border-color: #93C5FD; color: var(--azul); }
    .estado-btn.sel-resuelto   { background: #D1FAE5; border-color: #6EE7B7; color: #065F46; }

    /* Notas de resolución */
    .form-label { font-size: .76rem; font-weight: 700; color: var(--text-mid); letter-spacing: .02em; margin-bottom: .35rem; display: block; }
    .form-textarea { width: 100%; padding: .7rem .9rem; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface2); font-family: 'DM Sans', sans-serif; font-size: .875rem; color: var(--text); outline: none; resize: vertical; min-height: 80px; transition: border-color .2s; }
    .form-textarea:focus { border-color: var(--azul-light); box-shadow: 0 0 0 3px rgba(26,117,255,.1); background: #fff; }

    .btn-cancel { padding: .55rem 1.1rem; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; color: var(--text-mid); cursor: pointer; }
    .btn-save   { display: flex; align-items: center; gap: .45rem; padding: .55rem 1.25rem; background: var(--azul); border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; color: #fff; cursor: pointer; transition: background .2s; }
    .btn-save:hover { background: var(--azul-mid); }
    .btn-save:disabled { opacity: .6; cursor: not-allowed; }
    .btn-pdf  { display: flex; align-items: center; gap: .45rem; padding: .55rem 1.1rem; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; color: var(--text-mid); cursor: pointer; transition: all .2s; }
    .btn-pdf:hover { border-color: var(--danger); color: var(--danger); background: #FFF5F5; }

    /* ══ TOAST ══ */
    .toast-wrap { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; display: flex; flex-direction: column; gap: .5rem; }
    .toast { padding: .7rem 1.1rem; border-radius: 10px; font-size: .8rem; font-weight: 500; display: flex; align-items: center; gap: .55rem; color: #fff; box-shadow: 0 8px 24px rgba(0,0,0,.18); animation: fadeIn .3s ease; max-width: 280px; }
    .toast.success { background: var(--success); }
    .toast.error   { background: var(--danger); }
    .toast.info    { background: var(--azul); }

    @media (max-width: 900px) {
      .kpi-row { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .kpi-row { grid-template-columns: 1fr; }
      .det-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- PRELOADER -->
<div id="simgeca-preloader">
  <div class="pre-logo">
    <div class="pre-icon"><i class="fa-solid fa-wind"></i></div>
    <div>
      <div class="pre-title">SIMGECA</div>
      <div class="pre-sub">Sistema de Gestión de Clima</div>
    </div>
  </div>
  <div class="pre-bar-wrap"><div class="pre-bar"></div></div>
</div>

<!-- ══ SIDEBAR ══ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-row">
      <div class="logo-icon"><i class="fa-solid fa-wind"></i></div>
      <div>
        <div class="logo-text">SIMGECA</div>
        <div class="logo-sub">TecNM — Lázaro Cárdenas</div>
      </div>
    </div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">Principal</div>
    <a class="nav-item" href="dashboard.html"><i class="fa-solid fa-house"></i> Inicio</a>
    <div class="nav-section">Gestión</div>
    <a class="nav-item" href="acs.html"><i class="fa-solid fa-snowflake"></i> Aires Acondicionados</a>
    <a class="nav-item" href="aulas.html"><i class="fa-solid fa-school"></i> Aulas y Turnos</a>
    <a class="nav-item" href="usuarios.html"><i class="fa-solid fa-users"></i> Usuarios</a>
    <a class="nav-item" href="solicitudes.html"><i class="fa-solid fa-clipboard-list"></i> Solicitudes
      <span class="nav-badge" id="navBadgeSol">0</span></a>
    <div class="nav-section">Análisis</div>
    <a class="nav-item" href="monitoreo.html"><i class="fa-solid fa-chart-line"></i> Monitoreo</a>
    <a class="nav-item active" href="reportes.html"><i class="fa-solid fa-triangle-exclamation"></i> Reportes</a>
    <div class="nav-section">Sistema</div>
    <a class="nav-item" href="control.html"><i class="fa-solid fa-sliders"></i> Control AC</a>
    <a class="nav-item" href="sistema.html"><i class="fa-solid fa-circle-info"></i> Acerca del sistema</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar" id="userAvatar">A</div>
      <div class="user-info">
        <div class="user-name" id="userName">Administrador</div>
        <div class="user-role">Admin del sistema</div>
      </div>
      <button class="btn-logout" onclick="doLogout()" title="Cerrar sesión">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </div>
</aside>

<!-- ══ MAIN ══ -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <h1>Reportes de Mantenimiento</h1>
      <p>Problemas reportados por usuarios desde la app móvil</p>
    </div>
    <div class="topbar-right">
      <button class="btn-primary" onclick="exportarPDFGeneral()">
        <i class="fa-solid fa-file-pdf"></i> Exportar PDF
      </button>
    </div>
  </header>

  <div class="page-content">

    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-icon total"><i class="fa-solid fa-list-check"></i></div>
        <div>
          <div class="kpi-val" id="kpiTotal">—</div>
          <div class="kpi-lbl">Total reportes</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon pending"><i class="fa-solid fa-clock"></i></div>
        <div>
          <div class="kpi-val" id="kpiPendiente">—</div>
          <div class="kpi-lbl">Pendientes</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon process"><i class="fa-solid fa-gear"></i></div>
        <div>
          <div class="kpi-val" id="kpiEnProceso">—</div>
          <div class="kpi-lbl">En proceso</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon resolved"><i class="fa-solid fa-circle-check"></i></div>
        <div>
          <div class="kpi-val" id="kpiResuelto">—</div>
          <div class="kpi-lbl">Resueltos</div>
        </div>
      </div>
    </div>

    <!-- Tabs por estado -->
    <div class="tabs">
      <button class="tab active" onclick="cambiarTab('todos', this)">
        <i class="fa-solid fa-list"></i> Todos <span class="tab-count" id="tabCountTodos"></span>
      </button>
      <button class="tab" onclick="cambiarTab('pendiente', this)">
        <i class="fa-solid fa-clock"></i> Pendientes <span class="tab-count" id="tabCountPendiente"></span>
      </button>
      <button class="tab" onclick="cambiarTab('en_proceso', this)">
        <i class="fa-solid fa-gear"></i> En proceso <span class="tab-count" id="tabCountProceso"></span>
      </button>
      <button class="tab" onclick="cambiarTab('resuelto', this)">
        <i class="fa-solid fa-circle-check"></i> Resueltos <span class="tab-count" id="tabCountResuelto"></span>
      </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-wrap">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input class="search-input" type="text" id="searchInput" placeholder="Buscar por AC, aula o descripción..." oninput="renderReportes()"/>
      </div>
      <select class="filter-select" id="filtroAC" onchange="renderReportes()">
        <option value="">Todos los ACs</option>
      </select>
      <span class="count-badge" id="countBadge"></span>
    </div>

    <!-- Lista -->
    <div class="reporte-list" id="reporteList">
      <div class="empty-state">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <h3>Cargando reportes...</h3>
        <p>Conectando con Firestore</p>
      </div>
    </div>

  </div>
</div>

<!-- ══ MODAL DETALLE ══ -->
<div class="modal-overlay" id="modalDetalle">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="color:var(--warning);margin-right:.4rem"></i> Detalle del Reporte</span>
      <button class="modal-close" onclick="cerrarModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">

      <!-- Info grid -->
      <div class="det-grid">
        <div class="det-item">
          <div class="det-item-lbl">Equipo AC</div>
          <div class="det-item-val" id="detAC">—</div>
        </div>
        <div class="det-item">
          <div class="det-item-lbl">Aula</div>
          <div class="det-item-val" id="detAula">—</div>
        </div>
        <div class="det-item">
          <div class="det-item-lbl">Reportado por</div>
          <div class="det-item-val" id="detUsuario">—</div>
        </div>
        <div class="det-item">
          <div class="det-item-lbl">Fecha y hora</div>
          <div class="det-item-val" id="detFecha">—</div>
        </div>
      </div>

      <!-- Descripción -->
      <div class="det-section">
        <div class="det-label">Descripción del problema</div>
        <div class="desc-box" id="detDescripcion">—</div>
      </div>

      <!-- Notas de resolución (solo si tiene) -->
      <div class="det-section" id="secNotasExistentes" style="display:none">
        <div class="det-label">Notas de resolución anteriores</div>
        <div class="desc-box" id="detNotasAnt" style="background:#F0FDF4;border-color:#A7F3D0;color:#065F46">—</div>
      </div>

      <!-- Cambiar estado -->
      <div class="det-section">
        <div class="det-label">Actualizar estado</div>
        <div class="estado-selector" id="estadoSelector">
          <button class="estado-btn" onclick="selEstado('pendiente')" id="btnPendiente">
            <i class="fa-solid fa-clock"></i> Pendiente
          </button>
          <button class="estado-btn" onclick="selEstado('en_proceso')" id="btnEnProceso">
            <i class="fa-solid fa-gear"></i> En proceso
          </button>
          <button class="estado-btn" onclick="selEstado('resuelto')" id="btnResuelto">
            <i class="fa-solid fa-circle-check"></i> Resuelto
          </button>
        </div>
      </div>

      <!-- Notas del admin -->
      <div class="det-section">
        <label class="form-label" for="notasAdmin">Notas del técnico / admin</label>
        <textarea class="form-textarea" id="notasAdmin" placeholder="Agrega observaciones, acciones tomadas o pendientes..."></textarea>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-pdf" onclick="exportarPDFReporte()">
        <i class="fa-solid fa-file-pdf"></i> Exportar PDF
      </button>
      <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-save" id="btnGuardar" onclick="guardarCambios()">
        <i class="fa-solid fa-floppy-disk"></i> Guardar cambios
      </button>
    </div>
  </div>
</div>

<!-- ══ TOAST ══ -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCdbaYB4Ke0buAMFhlr4YzsJUo_uYgj3Hg",
    authDomain: "simgeca-26297.firebaseapp.com",
    projectId: "simgeca-26297",
    storageBucket: "simgeca-26297.firebasestorage.app",
    messagingSenderId: "28195458236",
    appId: "1:28195458236:web:9250f82b845665d82cd4b9"
  };
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db   = firebase.firestore();

  /* ══ STATE ══ */
  var todosReportes = [];
  var tabActual     = 'todos';
  var reporteActual = null;
  var estadoSel     = '';

  /* ══ AUTH ══ */
  auth.onAuthStateChanged(function(user) {
    if (!user) { window.location.replace('login.html'); return; }
    var nombre = user.displayName || user.email;
    document.getElementById('userName').textContent = nombre;
    document.getElementById('userAvatar').textContent = nombre.charAt(0).toUpperCase();
    cargarReportes();
    cargarBadgeSolicitudes();
  });

  function doLogout() {
    auth.signOut().then(function(){ window.location.replace('login.html'); });
  }

  /* ══ SOLICITUDES BADGE ══ */
  function cargarBadgeSolicitudes() {
    db.collection('solicitudes').where('estado','==','pendiente')
      .onSnapshot(function(snap){
        var b = document.getElementById('navBadgeSol');
        if (snap.size > 0) { b.textContent = snap.size; b.style.display = 'inline-block'; }
        else { b.style.display = 'none'; }
      });
  }

  /* ══ CARGAR REPORTES ══ */
  function cargarReportes() {
    db.collection('reportes_mantenimiento')
      .orderBy('fecha', 'desc')
      .onSnapshot(function(snap) {
        todosReportes = [];
        snap.forEach(function(doc) {
          todosReportes.push(Object.assign({ id: doc.id }, doc.data()));
        });

        // Si no hay datos reales, generar simulados para demo
        if (todosReportes.length === 0) {
          todosReportes = generarSimulados();
        }

        actualizarKPIs();
        poblarFiltroAC();
        renderReportes();
      }, function(err) {
        console.warn('Error Firestore, usando simulados:', err);
        todosReportes = generarSimulados();
        actualizarKPIs();
        poblarFiltroAC();
        renderReportes();
      });
  }

  /* ══ SIMULADOS ══ */
  function generarSimulados() {
    var problemas = [
      { tipo: 'No enfría', desc: 'El aire acondicionado está encendido pero no enfría el aula. La temperatura sigue igual que sin encenderlo.' },
      { tipo: 'Ruido extraño', desc: 'Se escucha un golpeteo constante cuando el equipo está funcionando. Suena como si algo estuviera suelto por dentro.' },
      { tipo: 'Gotea agua', desc: 'El equipo está goteando agua hacia adentro del salón. Ya hay manchas en el piso y el techo del aula.' },
      { tipo: 'No enciende', desc: 'El aire no enciende aunque se configura desde la app y el control. La luz indicadora tampoco parpadea.' },
      { tipo: 'Olor raro', desc: 'El equipo emite un olor a quemado cuando está funcionando. Varios alumnos reportaron mareo.' },
      { tipo: 'Control sin respuesta', desc: 'El control del aire no responde aunque tiene batería. El equipo no recibe comandos desde la app.' },
    ];
    var aulas = ['Aula 101','Aula 203','Lab Cómputo 1','Aula 305','Lab Electrónica','Aula 102'];
    var acs   = ['AC-101','AC-203','AC-LC1','AC-305','AC-LE1','AC-102'];
    var estados = ['pendiente','pendiente','en_proceso','resuelto','pendiente','en_proceso'];
    var usuarios = ['Juan Pérez López','María García Ramos','Carlos Soto Díaz','Ana Torres Vega','Luis Mendoza Cruz','Sofia Ruiz Flores'];
    var result = [];
    var now = Date.now();
    for (var i = 0; i < 6; i++) {
      var p = problemas[i];
      result.push({
        id: 'sim_' + i,
        acId: acs[i],
        aula: aulas[i],
        tipo: p.tipo,
        descripcion: p.desc,
        estado: estados[i],
        usuarioNombre: usuarios[i],
        usuarioCorreo: usuarios[i].toLowerCase().replace(/ /g,'_') + '@lcardenas.tecnm.mx',
        notasAdmin: estados[i] === 'resuelto' ? 'Se revisó el filtro y se limpió el condensador. Equipo funcionando correctamente.' : '',
        fecha: { toDate: function(){ return new Date(now - Math.random() * 7 * 86400000); } }
      });
    }
    return result;
  }

  /* ══ KPIs ══ */
  function actualizarKPIs() {
    var total = todosReportes.length;
    var pend  = todosReportes.filter(function(r){ return r.estado === 'pendiente'; }).length;
    var proc  = todosReportes.filter(function(r){ return r.estado === 'en_proceso'; }).length;
    var res   = todosReportes.filter(function(r){ return r.estado === 'resuelto'; }).length;
    document.getElementById('kpiTotal').textContent     = total;
    document.getElementById('kpiPendiente').textContent = pend;
    document.getElementById('kpiEnProceso').textContent = proc;
    document.getElementById('kpiResuelto').textContent  = res;
    document.getElementById('tabCountTodos').textContent     = total;
    document.getElementById('tabCountPendiente').textContent = pend;
    document.getElementById('tabCountProceso').textContent   = proc;
    document.getElementById('tabCountResuelto').textContent  = res;
  }

  /* ══ FILTRO AC ══ */
  function poblarFiltroAC() {
    var sel = document.getElementById('filtroAC');
    var actual = sel.value;
    var acs = [...new Set(todosReportes.map(function(r){ return r.acId || r.equipo || ''; }).filter(Boolean))];
    sel.innerHTML = '<option value="">Todos los ACs</option>';
    acs.forEach(function(ac){
      var opt = document.createElement('option');
      opt.value = ac; opt.textContent = ac;
      if (ac === actual) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  /* ══ TABS ══ */
  function cambiarTab(tab, el) {
    tabActual = tab;
    document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
    el.classList.add('active');
    renderReportes();
  }

  /* ══ RENDER ══ */
  function renderReportes() {
    var busq  = (document.getElementById('searchInput').value || '').toLowerCase();
    var filtAC = document.getElementById('filtroAC').value;

    var lista = todosReportes.filter(function(r) {
      if (tabActual !== 'todos' && r.estado !== tabActual) return false;
      if (filtAC && (r.acId || r.equipo || '') !== filtAC) return false;
      if (busq) {
        var haystack = [r.acId, r.aula, r.tipo, r.descripcion, r.usuarioNombre].join(' ').toLowerCase();
        if (!haystack.includes(busq)) return false;
      }
      return true;
    });

    document.getElementById('countBadge').textContent = lista.length + ' reporte(s)';
    var cont = document.getElementById('reporteList');

    if (lista.length === 0) {
      cont.innerHTML = '<div class="empty-state"><i class="fa-solid fa-triangle-exclamation"></i><h3>Sin reportes</h3><p>No hay reportes que coincidan con los filtros aplicados.</p></div>';
      return;
    }

    cont.innerHTML = lista.map(function(r, idx) {
      var fechaStr = '';
      try { fechaStr = r.fecha.toDate().toLocaleDateString('es-MX', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }); } catch(e){}
      var estadoLabel = { pendiente: 'Pendiente', en_proceso: 'En proceso', resuelto: 'Resuelto' }[r.estado] || r.estado;
      var iconoMap    = { pendiente: 'fa-clock', en_proceso: 'fa-gear', resuelto: 'fa-circle-check' };
      var icono = iconoMap[r.estado] || 'fa-circle-exclamation';
      return [
        '<div class="reporte-card" onclick="abrirDetalle(\'' + r.id + '\')" style="animation-delay:' + (idx * 0.05) + 's">',
          '<div class="reporte-bar bar-' + r.estado + '"></div>',
          '<div class="reporte-body">',
            '<div class="reporte-icon-wrap icon-' + r.estado + '">',
              '<i class="fa-solid ' + icono + '"></i>',
            '</div>',
            '<div class="reporte-main">',
              '<div class="reporte-header">',
                '<span class="reporte-titulo">' + (r.tipo || 'Reporte de mantenimiento') + '</span>',
                '<span class="estado-badge badge-' + r.estado + '">' + estadoLabel + '</span>',
              '</div>',
              '<div class="reporte-desc">' + (r.descripcion || 'Sin descripción.') + '</div>',
              '<div class="reporte-meta">',
                '<span class="meta-item"><i class="fa-solid fa-snowflake"></i> ' + (r.acId || r.equipo || 'N/A') + '</span>',
                '<span class="meta-item"><i class="fa-solid fa-school"></i> ' + (r.aula || 'N/A') + '</span>',
                '<span class="meta-item"><i class="fa-solid fa-user"></i> ' + (r.usuarioNombre || r.usuario || 'Usuario') + '</span>',
                (fechaStr ? '<span class="meta-item"><i class="fa-solid fa-calendar"></i> ' + fechaStr + '</span>' : ''),
              '</div>',
            '</div>',
          '</div>',
          '<div class="reporte-footer">',
            '<div class="reporte-footer-left">',
              r.notasAdmin ? '<i class="fa-solid fa-note-sticky" style="color:var(--accent)"></i> Con notas del admin' : '<i class="fa-regular fa-note-sticky"></i> Sin notas',
            '</div>',
            '<button class="btn-ver" onclick="event.stopPropagation(); abrirDetalle(\'' + r.id + '\')"><i class="fa-solid fa-eye"></i> Ver detalle</button>',
          '</div>',
        '</div>'
      ].join('');
    }).join('');
  }

  /* ══ MODAL DETALLE ══ */
  function abrirDetalle(id) {
    reporteActual = todosReportes.find(function(r){ return r.id === id; });
    if (!reporteActual) return;
    var r = reporteActual;
    var fechaStr = '';
    try { fechaStr = r.fecha.toDate().toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }); } catch(e){}

    document.getElementById('detAC').textContent       = r.acId || r.equipo || 'N/A';
    document.getElementById('detAula').textContent     = r.aula || 'N/A';
    document.getElementById('detUsuario').textContent  = (r.usuarioNombre || r.usuario || 'N/A') + (r.usuarioCorreo ? '\n' + r.usuarioCorreo : '');
    document.getElementById('detFecha').textContent    = fechaStr || 'N/A';
    document.getElementById('detDescripcion').textContent = r.descripcion || 'Sin descripción.';
    document.getElementById('notasAdmin').value        = r.notasAdmin || '';

    var secNotas = document.getElementById('secNotasExistentes');
    if (r.notasAdmin) {
      document.getElementById('detNotasAnt').textContent = r.notasAdmin;
      secNotas.style.display = 'block';
    } else {
      secNotas.style.display = 'none';
    }

    estadoSel = r.estado || 'pendiente';
    actualizarBotonesEstado();

    document.getElementById('modalDetalle').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function cerrarModal() {
    document.getElementById('modalDetalle').classList.remove('open');
    document.body.style.overflow = '';
    reporteActual = null;
  }

  /* ══ SELECTOR ESTADO ══ */
  function selEstado(estado) {
    estadoSel = estado;
    actualizarBotonesEstado();
  }
  function actualizarBotonesEstado() {
    ['pendiente','en_proceso','resuelto'].forEach(function(e) {
      var btn = document.getElementById('btn' + e.split('_').map(function(w){ return w[0].toUpperCase()+w.slice(1); }).join(''));
      if (!btn) {
        // fallback: find by text content approach
        return;
      }
      btn.className = 'estado-btn' + (estadoSel === e ? ' sel-' + e : '');
    });
    // Simpler approach with IDs we actually set:
    document.getElementById('btnPendiente').className  = 'estado-btn' + (estadoSel === 'pendiente'  ? ' sel-pendiente'  : '');
    document.getElementById('btnEnProceso').className  = 'estado-btn' + (estadoSel === 'en_proceso' ? ' sel-en_proceso' : '');
    document.getElementById('btnResuelto').className   = 'estado-btn' + (estadoSel === 'resuelto'   ? ' sel-resuelto'   : '');
  }

  /* ══ GUARDAR CAMBIOS ══ */
  function guardarCambios() {
    if (!reporteActual) return;
    var btn = document.getElementById('btnGuardar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';

    var notas = document.getElementById('notasAdmin').value.trim();

    // Si es simulado (sin ID real), solo actualizar localmente
    if (reporteActual.id.startsWith('sim_')) {
      reporteActual.estado = estadoSel;
      reporteActual.notasAdmin = notas;
      actualizarKPIs();
      renderReportes();
      cerrarModal();
      showToast('Cambios guardados (modo demo)', 'success');
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar cambios';
      return;
    }

    db.collection('reportes_mantenimiento').doc(reporteActual.id).update({
      estado: estadoSel,
      notasAdmin: notas,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function() {
      showToast('Reporte actualizado correctamente', 'success');
      cerrarModal();
    }).catch(function(err) {
      showToast('Error al guardar: ' + err.message, 'error');
    }).finally(function() {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar cambios';
    });
  }

  /* ══ EXPORTAR PDF — UN REPORTE ══ */
  function exportarPDFReporte() {
    if (!reporteActual) return;
    var r = reporteActual;
    var { jsPDF } = window.jspdf;
    var doc = new jsPDF({ unit: 'mm', format: 'a4' });
    var fechaStr = '';
    try { fechaStr = r.fecha.toDate().toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }); } catch(e){}
    var estadoLabel = { pendiente:'Pendiente', en_proceso:'En proceso', resuelto:'Resuelto' }[r.estado] || r.estado;

    // Header
    doc.setFillColor(0, 59, 142);
    doc.rect(0, 0, 210, 30, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('SIMGECA', 15, 12);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('TecNM Campus Lázaro Cárdenas', 15, 19);
    doc.text('Reporte de Mantenimiento', 15, 25);
    doc.text('Generado: ' + new Date().toLocaleDateString('es-MX'), 150, 19);

    // Título del reporte
    doc.setTextColor(13, 27, 62);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.text(r.tipo || 'Reporte de Mantenimiento', 15, 42);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(120, 140, 184);
    doc.text('Estado: ' + estadoLabel, 15, 49);

    // Línea
    doc.setDrawColor(221, 229, 244);
    doc.line(15, 53, 195, 53);

    // Datos
    var y = 62;
    var campos = [
      ['Equipo AC',      r.acId || r.equipo || 'N/A'],
      ['Aula',           r.aula || 'N/A'],
      ['Reportado por',  (r.usuarioNombre || 'N/A')],
      ['Correo',         (r.usuarioCorreo || 'N/A')],
      ['Fecha y hora',   fechaStr || 'N/A'],
    ];
    campos.forEach(function(c) {
      doc.setFont('helvetica', 'bold'); doc.setFontSize(9); doc.setTextColor(61, 82, 128);
      doc.text(c[0] + ':', 15, y);
      doc.setFont('helvetica', 'normal'); doc.setTextColor(13, 27, 62);
      doc.text(c[1], 60, y);
      y += 8;
    });

    y += 4;
    doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(61, 82, 128);
    doc.text('Descripción del problema:', 15, y);
    y += 6;
    doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.setTextColor(13, 27, 62);
    var descLines = doc.splitTextToSize(r.descripcion || 'Sin descripción.', 175);
    doc.text(descLines, 15, y);
    y += descLines.length * 5 + 8;

    if (r.notasAdmin) {
      doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(61, 82, 128);
      doc.text('Notas del técnico / admin:', 15, y);
      y += 6;
      doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.setTextColor(6, 95, 70);
      var notaLines = doc.splitTextToSize(r.notasAdmin, 175);
      doc.text(notaLines, 15, y);
    }

    // Footer
    doc.setFillColor(240, 244, 250);
    doc.rect(0, 280, 210, 17, 'F');
    doc.setTextColor(122, 144, 184);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text('SIMGECA — Sistema de Gestión de Clima para Aulas | TecNM Lázaro Cárdenas', 15, 290);

    doc.save('reporte_' + (r.acId || 'AC') + '_' + Date.now() + '.pdf');
    showToast('PDF generado correctamente', 'success');
  }

  /* ══ EXPORTAR PDF — GENERAL ══ */
  function exportarPDFGeneral() {
    var { jsPDF } = window.jspdf;
    var doc = new jsPDF({ unit: 'mm', format: 'a4' });
    var lista = todosReportes;

    // Header
    doc.setFillColor(0, 59, 142);
    doc.rect(0, 0, 210, 30, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('SIMGECA', 15, 12);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('TecNM Campus Lázaro Cárdenas', 15, 19);
    doc.text('Reporte General de Mantenimiento', 15, 25);
    doc.text('Generado: ' + new Date().toLocaleDateString('es-MX'), 140, 25);

    // KPIs
    var pend = lista.filter(function(r){ return r.estado==='pendiente'; }).length;
    var proc = lista.filter(function(r){ return r.estado==='en_proceso'; }).length;
    var res  = lista.filter(function(r){ return r.estado==='resuelto'; }).length;

    doc.setTextColor(13, 27, 62);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('Resumen', 15, 42);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(61, 82, 128);
    doc.text('Total: ' + lista.length + '   Pendientes: ' + pend + '   En proceso: ' + proc + '   Resueltos: ' + res, 15, 49);

    doc.setDrawColor(221, 229, 244);
    doc.line(15, 53, 195, 53);

    // Tabla
    var y = 60;
    var cols = ['AC', 'Aula', 'Problema', 'Estado', 'Fecha'];
    var widths = [25, 30, 75, 28, 32];
    var x = 15;

    // Header tabla
    doc.setFillColor(232, 240, 254);
    doc.rect(x, y-5, 180, 8, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(0, 59, 142);
    var cx = x;
    cols.forEach(function(c, i){ doc.text(c, cx + 1, y); cx += widths[i]; });
    y += 6;
    doc.setDrawColor(200, 210, 235);
    doc.line(x, y - 1, x + 180, y - 1);

    lista.forEach(function(r, idx) {
      if (y > 265) {
        doc.addPage();
        y = 20;
      }
      var fechaStr = '';
      try { fechaStr = r.fecha.toDate().toLocaleDateString('es-MX', { day:'2-digit', month:'short', year:'numeric' }); } catch(e){}
      var estadoLabel = { pendiente:'Pendiente', en_proceso:'En proceso', resuelto:'Resuelto' }[r.estado] || r.estado;

      if (idx % 2 === 0) {
        doc.setFillColor(248, 250, 255);
        doc.rect(x, y - 4, 180, 8, 'F');
      }

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7.5);
      doc.setTextColor(13, 27, 62);
      var row = [
        r.acId || r.equipo || '-',
        r.aula || '-',
        (r.tipo || r.descripcion || '-').substring(0, 48) + ((r.tipo || '').length > 48 ? '…' : ''),
        estadoLabel,
        fechaStr
      ];
      cx = x;
      row.forEach(function(cell, i){ doc.text(String(cell), cx + 1, y); cx += widths[i]; });
      y += 8;
    });

    // Footer
    doc.setFillColor(240, 244, 250);
    var totalPages = doc.internal.getNumberOfPages();
    for (var p = 1; p <= totalPages; p++) {
      doc.setPage(p);
      doc.rect(0, 280, 210, 17, 'F');
      doc.setTextColor(122, 144, 184);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text('SIMGECA — Sistema de Gestión de Clima | TecNM Lázaro Cárdenas', 15, 290);
      doc.text('Página ' + p + ' de ' + totalPages, 185, 290, { align: 'right' });
    }

    doc.save('reportes_mantenimiento_' + Date.now() + '.pdf');
    showToast('PDF general exportado', 'success');
  }

  /* ══ TOAST ══ */
  function showToast(msg, type) {
    var wrap = document.getElementById('toastWrap');
    var icons = { success:'fa-circle-check', error:'fa-circle-xmark', info:'fa-circle-info' };
    var t = document.createElement('div');
    t.className = 'toast ' + (type || 'info');
    t.innerHTML = '<i class="fa-solid ' + (icons[type] || 'fa-circle-info') + '"></i> ' + msg;
    wrap.appendChild(t);
    setTimeout(function(){ t.remove(); }, 3500);
  }

  /* ══ PRELOADER ══ */
  (function(){
    var el = document.getElementById('simgeca-preloader');
    if (!el) return;
    function dismiss(){ el.classList.add('fade-out'); setTimeout(function(){ el.remove(); }, 550); }
    if (document.readyState === 'complete') { setTimeout(dismiss, 400); }
    else { window.addEventListener('load', function(){ setTimeout(dismiss, 400); }); }
  })();
</script>
</body>
</html>
