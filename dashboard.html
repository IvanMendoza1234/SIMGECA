<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIMGECA — Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --azul:       #003B8E;
      --azul-mid:   #0057CC;
      --azul-light: #1A75FF;
      --azul-pale:  #E8F0FE;
      --accent:     #00C2A8;
      --danger:     #EF4444;
      --success:    #10B981;
      --warning:    #F59E0B;
      --bg:         #F0F4FA;
      --surface:    #FFFFFF;
      --surface2:   #F8FAFF;
      --text:       #0D1B3E;
      --text-mid:   #3D5280;
      --text-light: #7A90B8;
      --border:     #DDE5F4;
      --sidebar-w:  265px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; overflow-x: hidden; }

    /* ══ SIDEBAR ══ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--azul);
      min-height: 100vh;
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; z-index: 100;
    }
    .sidebar-logo { padding: 1.5rem 1.25rem 1.1rem; border-bottom: 1px solid rgba(255,255,255,.08); }
    .logo-row { display: flex; align-items: center; gap: .7rem; }
    .logo-icon { width: 38px; height: 38px; background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.18); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--accent); }
    .logo-text { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: -.5px; }
    .logo-sub  { font-size: .62rem; color: rgba(255,255,255,.35); margin-top: .1rem; line-height: 1.3; }

    .sidebar-nav { flex: 1; padding: .75rem 0; overflow-y: auto; }
    .nav-section { font-size: .6rem; font-weight: 700; color: rgba(255,255,255,.28); text-transform: uppercase; letter-spacing: .1em; padding: .85rem 1.25rem .3rem; }
    .nav-item {
      display: flex; align-items: center; gap: .7rem;
      padding: .65rem 1.25rem;
      color: rgba(255,255,255,.55);
      font-size: .85rem; font-weight: 500;
      cursor: pointer; transition: all .2s;
      border-left: 3px solid transparent;
      text-decoration: none;
    }
    .nav-item:hover { background: rgba(255,255,255,.06); color: rgba(255,255,255,.9); }
    .nav-item.active { background: rgba(255,255,255,.1); color: #fff; border-left-color: var(--accent); }
    .nav-item i { width: 17px; text-align: center; font-size: .9rem; }
    .nav-badge { margin-left: auto; background: var(--danger); color: #fff; font-size: .62rem; font-weight: 700; padding: .12rem .42rem; border-radius: 20px; }

    .sidebar-footer { padding: .9rem 1.25rem; border-top: 1px solid rgba(255,255,255,.08); }
    .user-card { display: flex; align-items: center; gap: .65rem; }
    .user-avatar { width: 34px; height: 34px; background: var(--accent); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: .85rem; color: #fff; font-weight: 700; flex-shrink: 0; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: .8rem; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: .68rem; color: rgba(255,255,255,.38); }
    .btn-logout { background: none; border: none; cursor: pointer; color: rgba(255,255,255,.35); font-size: .88rem; padding: .25rem; border-radius: 6px; transition: color .2s; }
    .btn-logout:hover { color: var(--danger); }

    /* ══ MAIN ══ */
    .main { margin-left: var(--sidebar-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }

    .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: .9rem 1.75rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
    .topbar-left h1 { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--text); }
    .topbar-left p  { font-size: .75rem; color: var(--text-light); margin-top: .05rem; }
    .topbar-right   { display: flex; align-items: center; gap: .6rem; }
    .chip-date { display: flex; align-items: center; gap: .35rem; background: var(--azul-pale); border: 1.5px solid #C5D8FF; border-radius: 8px; padding: .35rem .7rem; font-size: .73rem; font-weight: 600; color: var(--azul); }
    .topbar-btn { width: 36px; height: 36px; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 9px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-mid); font-size: .88rem; transition: all .2s; position: relative; }
    .topbar-btn:hover { border-color: var(--azul-light); color: var(--azul); }
    .notif-dot { position: absolute; top: 6px; right: 6px; width: 7px; height: 7px; background: var(--danger); border-radius: 50%; border: 1.5px solid var(--surface); display: none; }

    .page-content { padding: 1.5rem 1.75rem; flex: 1; }
    .section { display: none; animation: fadeIn .3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

    /* ══ KPI GRID ══ */
    .kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 1rem; margin-bottom: 1.25rem; }
    .kpi-card { background: var(--surface); border: 1.5px solid var(--border); border-radius: 14px; padding: 1.1rem; position: relative; overflow: hidden; transition: box-shadow .2s, transform .2s; }
    .kpi-card:hover { box-shadow: 0 6px 24px rgba(0,59,142,.08); transform: translateY(-1px); }
    .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .kpi-card.k1::after { background: var(--azul-light); }
    .kpi-card.k2::after { background: var(--accent); }
    .kpi-card.k3::after { background: var(--warning); }
    .kpi-card.k4::after { background: var(--success); }
    .kpi-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: .65rem; }
    .kpi-icon { width: 40px; height: 40px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
    .k1 .kpi-icon { background: #EEF3FF; color: var(--azul-light); }
    .k2 .kpi-icon { background: #E6FAF8; color: var(--accent); }
    .k3 .kpi-icon { background: #FEF3C7; color: var(--warning); }
    .k4 .kpi-icon { background: #D1FAE5; color: var(--success); }
    .kpi-val   { font-family: 'Syne', sans-serif; font-size: 1.9rem; font-weight: 800; color: var(--text); line-height: 1; margin-bottom: .2rem; }
    .kpi-label { font-size: .76rem; color: var(--text-light); font-weight: 500; }
    .kpi-sub   { font-size: .7rem; color: var(--text-light); margin-top: .15rem; }

    /* ══ CHARTS ══ */
    .charts-row { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1.25rem; }
    .card { background: var(--surface); border: 1.5px solid var(--border); border-radius: 14px; padding: 1.1rem; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .card-title { font-family: 'Syne', sans-serif; font-size: .95rem; font-weight: 700; color: var(--text); }
    .card-sub   { font-size: .72rem; color: var(--text-light); margin-top: .08rem; }
    .card-badge { font-size: .7rem; font-weight: 600; background: var(--azul-pale); color: var(--azul); padding: .25rem .6rem; border-radius: 7px; }

    .donut-wrap   { display: flex; flex-direction: column; align-items: center; }
    .donut-canvas { max-width: 170px; margin: 0 auto; }
    .donut-legend { width: 100%; margin-top: .9rem; display: flex; flex-direction: column; gap: .45rem; }
    .legend-row   { display: flex; align-items: center; justify-content: space-between; font-size: .76rem; }
    .legend-dot   { width: 9px; height: 9px; border-radius: 3px; display: inline-block; margin-right: .4rem; }
    .legend-label { color: var(--text-mid); display: flex; align-items: center; }
    .legend-val   { font-weight: 700; color: var(--text); }

    /* ══ BOTTOM ROW ══ */
    .bottom-row { display: grid; grid-template-columns: 3fr 2fr; gap: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; font-size: .7rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .06em; padding: .45rem .7rem; border-bottom: 1.5px solid var(--border); }
    tbody tr { border-bottom: 1px solid var(--border); transition: background .15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td { padding: .65rem .7rem; font-size: .8rem; color: var(--text-mid); vertical-align: middle; }
    td strong { color: var(--text); font-weight: 600; }

    .status-chip { display: inline-flex; align-items: center; gap: .3rem; padding: .22rem .55rem; border-radius: 6px; font-size: .7rem; font-weight: 600; }
    .chip-pending  { background: #FEF3C7; color: #92400E; }
    .chip-approved { background: #D1FAE5; color: #065F46; }
    .chip-rejected { background: #FEE2E2; color: #991B1B; }

    .action-btns { display: flex; gap: .35rem; }
    .btn-sm { padding: .28rem .6rem; border-radius: 6px; font-size: .7rem; font-weight: 600; border: none; cursor: pointer; transition: all .15s; }
    .btn-approve { background: #D1FAE5; color: #065F46; }
    .btn-approve:hover { background: #A7F3D0; }
    .btn-reject  { background: #FEE2E2; color: #991B1B; }
    .btn-reject:hover  { background: #FECACA; }

    .activity-list { display: flex; flex-direction: column; }
    .activity-item { display: flex; align-items: flex-start; gap: .65rem; padding: .65rem 0; border-bottom: 1px solid var(--border); }
    .activity-item:last-child { border-bottom: none; }
    .act-icon { width: 30px; height: 30px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: .75rem; flex-shrink: 0; margin-top: .05rem; }
    .act-on   { background: #D1FAE5; color: #065F46; }
    .act-off  { background: #FEE2E2; color: #991B1B; }
    .act-req  { background: #FEF3C7; color: #92400E; }
    .act-user { background: var(--azul-pale); color: var(--azul); }
    .act-title { font-size: .8rem; font-weight: 600; color: var(--text); }
    .act-desc  { font-size: .72rem; color: var(--text-light); margin-top: .08rem; }
    .act-time  { font-size: .68rem; color: var(--text-light); margin-top: .15rem; }

    .empty-state { text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: .82rem; }
    .empty-state i { font-size: 1.8rem; margin-bottom: .5rem; display: block; opacity: .4; }

    /* Toast */
    .toast-wrap { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; display: flex; flex-direction: column; gap: .5rem; }
    .toast { padding: .7rem 1.1rem; border-radius: 10px; font-size: .8rem; font-weight: 500; display: flex; align-items: center; gap: .55rem; color: #fff; box-shadow: 0 8px 24px rgba(0,0,0,.18); animation: fadeIn .3s ease; max-width: 280px; }
    .toast.success { background: var(--success); }
    .toast.error   { background: var(--danger); }
    .toast.info    { background: var(--azul); }

    @media (max-width: 1100px) {
      .kpi-grid { grid-template-columns: repeat(2,1fr); }
      .charts-row, .bottom-row { grid-template-columns: 1fr; }
    }
  
    /* ══ PRELOADER ══ */
    #simgeca-preloader {
      position: fixed; inset: 0; z-index: 9999;
      background: #003B8E;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 1.5rem;
      transition: opacity .5s ease, visibility .5s ease;
    }
    #simgeca-preloader.fade-out {
      opacity: 0; visibility: hidden;
    }
    .pre-logo {
      display: flex; flex-direction: column; align-items: center; gap: .6rem;
    }
    .pre-icon {
      width: 64px; height: 64px;
      background: rgba(255,255,255,.1);
      border: 1.5px solid rgba(255,255,255,.2);
      border-radius: 18px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.75rem; color: #00C2A8;
      animation: pre-pulse 1.8s ease-in-out infinite;
    }
    .pre-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.5rem; font-weight: 800;
      color: #fff; letter-spacing: -.5px;
    }
    .pre-sub {
      font-size: .68rem; color: rgba(255,255,255,.35);
      text-transform: uppercase; letter-spacing: .1em;
    }
    .pre-bar-wrap {
      width: 180px; height: 3px;
      background: rgba(255,255,255,.12);
      border-radius: 99px; overflow: hidden;
    }
    .pre-bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #00C2A8, #1A75FF);
      border-radius: 99px;
      animation: pre-load 1.6s cubic-bezier(.4,0,.2,1) forwards;
    }
    @keyframes pre-load {
      0%   { width: 0%; }
      60%  { width: 75%; }
      100% { width: 100%; }
    }
    @keyframes pre-pulse {
      0%, 100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(0,194,168,.3); }
      50%       { transform: scale(1.06); box-shadow: 0 0 0 12px rgba(0,194,168,0); }
    }

  </style>
</head>
<body>

  <!-- PRELOADER -->
  <div id="simgeca-preloader">
    <div class="pre-logo">
      <div class="pre-icon"><i class="fa-solid fa-wind"></i></div>
      <div>
        <div class="pre-title">SIMGECA</div>
        <div class="pre-sub">Sistema de Gestión de Clima</div>
      </div>
    </div>
    <div class="pre-bar-wrap">
      <div class="pre-bar"></div>
    </div>
  </div>


<!-- ══ SIDEBAR ══ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-row">
      <div class="logo-icon"><i class="fa-solid fa-wind"></i></div>
      <div>
        <div class="logo-text">SIMGECA</div>
        <div class="logo-sub">TecNM — Lázaro Cárdenas</div>
      </div>
    </div>
  </div>

  <nav class="sidebar-nav">

    <div class="nav-section">Principal</div>
    <a class="nav-item active" href="dashboard.html">
      <i class="fa-solid fa-house"></i> Inicio
    </a>

    <div class="nav-section">Gestión</div>
    <a class="nav-item" href="acs.html">
      <i class="fa-solid fa-snowflake"></i> Aires Acondicionados
    </a>
    <a class="nav-item" href="aulas.html">
      <i class="fa-solid fa-school"></i> Aulas y Turnos
    </a>
    <a class="nav-item" href="usuarios.html">
      <i class="fa-solid fa-users"></i> Usuarios
    </a>
    <a class="nav-item" href="solicitudes.html">
      <i class="fa-solid fa-clipboard-list"></i> Solicitudes
      <span class="nav-badge" id="navBadgeSol" style="display:none">0</span>
    </a>

    <div class="nav-section">Análisis</div>
    <a class="nav-item" href="monitoreo.html">
      <i class="fa-solid fa-chart-line"></i> Monitoreo
    </a>
    <a class="nav-item" href="reportes.html">
      <i class="fa-solid fa-triangle-exclamation"></i> Reportes
    </a>
    <a class="nav-item" href="control.html"><i class="fa-solid fa-sliders"></i> Control AC</a>

    <div class="nav-section">Sistema</div>
    <a class="nav-item" href="programacion.html">
      <i class="fa-solid fa-calendar-check"></i> Programación AC
    </a>
    <a class="nav-item" href="sistema.html">
      <i class="fa-solid fa-circle-info"></i> Acerca del sistema
    </a>

  </nav>

  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar" id="userAvatar">A</div>
      <div class="user-info">
        <div class="user-name" id="userName">Administrador</div>
        <div class="user-role">Admin del sistema</div>
      </div>
      <button class="btn-logout" onclick="doLogout()" title="Cerrar sesión">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </div>
</aside>

<!-- ══ MAIN ══ -->
<div class="main">

  <header class="topbar">
    <div class="topbar-left">
      <h1>Panel de inicio</h1>
      <p>Resumen general del sistema SIMGECA</p>
    </div>
    <div class="topbar-right">
      <div class="chip-date">
        <i class="fa-regular fa-calendar"></i>
        <span id="fechaHoy"></span>
      </div>
      <div class="topbar-btn" title="Notificaciones">
        <i class="fa-regular fa-bell"></i>
        <span class="notif-dot" id="notifDot"></span>
      </div>
    </div>
  </header>

  <div class="page-content">
    <div class="section active" id="sec-inicio">

      <!-- KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card k1">
          <div class="kpi-top"><div class="kpi-icon"><i class="fa-solid fa-snowflake"></i></div></div>
          <div class="kpi-val" id="kpiTotalACs">0</div>
          <div class="kpi-label">Equipos AC registrados</div>
          <div class="kpi-sub" id="kpiActivosACs">0 activos ahora mismo</div>
        </div>
        <div class="kpi-card k2">
          <div class="kpi-top"><div class="kpi-icon"><i class="fa-solid fa-bolt"></i></div></div>
          <div class="kpi-val" id="kpiKwh">0</div>
          <div class="kpi-label">kWh consumidos este mes</div>
          <div class="kpi-sub">Estimación por software</div>
        </div>
        <div class="kpi-card k3">
          <div class="kpi-top"><div class="kpi-icon"><i class="fa-solid fa-clock"></i></div></div>
          <div class="kpi-val" id="kpiSolicitudes">0</div>
          <div class="kpi-label">Solicitudes pendientes</div>
          <div class="kpi-sub">Requieren aprobación</div>
        </div>
        <div class="kpi-card k4">
          <div class="kpi-top"><div class="kpi-icon"><i class="fa-solid fa-users"></i></div></div>
          <div class="kpi-val" id="kpiUsuarios">0</div>
          <div class="kpi-label">Usuarios registrados</div>
          <div class="kpi-sub" id="kpiSubUsuarios">0 docentes · 0 alumnos</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-row">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Estado de ACs</div>
              <div class="card-sub">Distribución actual</div>
            </div>
            <span class="card-badge">En vivo</span>
          </div>
          <div class="donut-wrap">
            <div class="donut-canvas"><canvas id="chartDonut"></canvas></div>
            <div class="donut-legend">
              <div class="legend-row">
                <span class="legend-label"><span class="legend-dot" style="background:#1A75FF"></span>Encendidos</span>
                <span class="legend-val" id="legEncendidos">0</span>
              </div>
              <div class="legend-row">
                <span class="legend-label"><span class="legend-dot" style="background:#DDE5F4"></span>Apagados</span>
                <span class="legend-val" id="legApagados">0</span>
              </div>
              <div class="legend-row">
                <span class="legend-label"><span class="legend-dot" style="background:#F59E0B"></span>Mantenimiento</span>
                <span class="legend-val" id="legMantenimiento">0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Consumo energético</div>
              <div class="card-sub">Últimos 7 días — kWh</div>
            </div>
          </div>
          <canvas id="chartBar" height="190"></canvas>
        </div>
      </div>

      <!-- Bottom -->
      <div class="bottom-row">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Solicitudes pendientes</div>
              <div class="card-sub">Requieren tu aprobación</div>
            </div>
            <span class="card-badge" id="badgeSol">0 pendientes</span>
          </div>
          <table>
            <thead>
              <tr>
                <th>Solicitante</th><th>Aula</th><th>Hora</th><th>Estado</th><th>Acción</th>
              </tr>
            </thead>
            <tbody id="tablaSolicitudes">
              <tr><td colspan="5"><div class="empty-state"><i class="fa-regular fa-clipboard"></i>No hay solicitudes pendientes</div></td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Actividad reciente</div>
              <div class="card-sub">Últimos eventos del sistema</div>
            </div>
          </div>
          <div class="activity-list" id="activityList">
            <div class="empty-state"><i class="fa-regular fa-clock"></i>Sin actividad reciente</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCdbaYB4Ke0buAMFhlr4YzsJUo_uYgj3Hg",
    authDomain: "simgeca-26297.firebaseapp.com",
    projectId: "simgeca-26297",
    storageBucket: "simgeca-26297.firebasestorage.app",
    messagingSenderId: "28195458236",
    appId: "1:28195458236:web:9250f82b845665d82cd4b9"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Protección de ruta
  auth.onAuthStateChanged(user => {
    if (!user) { window.location.href = 'login.html'; return; }
    const email = user.email || '';
    document.getElementById('userName').textContent   = email.split('@')[0];
    document.getElementById('userAvatar').textContent = email.charAt(0).toUpperCase();
    cargarDashboard();
  });

  function doLogout() {
    auth.signOut().then(() => window.location.href = 'login.html');
  }

  document.getElementById('fechaHoy').textContent =
    new Date().toLocaleDateString('es-MX', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // ── Inicializar gráficas vacías ──
  const donutChart = new Chart(document.getElementById('chartDonut'), {
    type: 'doughnut',
    data: {
      labels: ['Encendidos','Apagados','Mantenimiento'],
      datasets: [{ data: [0,0,0], backgroundColor: ['#1A75FF','#DDE5F4','#F59E0B'], borderWidth: 0, hoverOffset: 6 }]
    },
    options: {
      cutout: '72%',
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} equipos` }}
      }
    }
  });

  const diasLabels = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    diasLabels.push(d.toLocaleDateString('es-MX', { weekday:'short', day:'numeric' }));
  }

  const barChart = new Chart(document.getElementById('chartBar'), {
    type: 'bar',
    data: {
      labels: diasLabels,
      datasets: [{ label: 'kWh', data: [0,0,0,0,0,0,0], backgroundColor: '#C5D8FF', borderRadius: 8, borderSkipped: false }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.raw} kWh` }}},
      scales: {
        y: { beginAtZero: true, grid: { color: '#EEF1F8' }, ticks: { font: { family: 'DM Sans', size: 11 }, color: '#7A90B8' }},
        x: { grid: { display: false }, ticks: { font: { family: 'DM Sans', size: 11 }, color: '#7A90B8' }}
      }
    }
  });

  // ── Cargar dashboard ──
  async function cargarDashboard() {
    await Promise.all([
      cargarACs(),
      cargarUsuarios(),
      cargarSolicitudes(),
      cargarActividad(),
      cargarConsumoSemanal(),
    ]);
  }

  async function cargarACs() {
    try {
      const snap = await db.collection('aires_acondicionados').get();
      let total = snap.size, encendidos = 0, apagados = 0, mantenimiento = 0, kwh = 0;
      snap.forEach(doc => {
        const d = doc.data();
        const estado = d.estado || 'apagado';
        if (estado === 'encendido')       encendidos++;
        else if (estado === 'mantenimiento') mantenimiento++;
        else                               apagados++;
        kwh += d.consumo_mes || 0;
      });
      document.getElementById('kpiTotalACs').textContent      = total;
      document.getElementById('kpiActivosACs').textContent    = `${encendidos} activos ahora mismo`;
      document.getElementById('kpiKwh').textContent           = kwh.toFixed(1);
      document.getElementById('legEncendidos').textContent    = encendidos;
      document.getElementById('legApagados').textContent      = apagados;
      document.getElementById('legMantenimiento').textContent = mantenimiento;
      donutChart.data.datasets[0].data = [encendidos, apagados, mantenimiento];
      donutChart.update();
    } catch(e) { console.error('ACs:', e); }
  }

  async function cargarUsuarios() {
    try {
      const snap = await db.collection('usuarios').get();
      let docentes = 0, alumnos = 0;
      snap.forEach(doc => {
        const rol = doc.data().rol || '';
        if (rol === 'docente') docentes++;
        if (rol === 'alumno')  alumnos++;
      });
      document.getElementById('kpiUsuarios').textContent    = snap.size;
      document.getElementById('kpiSubUsuarios').textContent = `${docentes} docentes · ${alumnos} alumnos`;
    } catch(e) { console.error('Usuarios:', e); }
  }

  async function cargarSolicitudes() {
    try {
      const snap = await db.collection('solicitudes')
        .where('estado', '==', 'pendiente')
        .orderBy('fecha_solicitud', 'desc')
        .limit(10)
        .get();

      const total = snap.size;
      document.getElementById('kpiSolicitudes').textContent = total;
      document.getElementById('badgeSol').textContent       = `${total} pendiente${total !== 1 ? 's' : ''}`;

      const badge = document.getElementById('navBadgeSol');
      badge.textContent     = total;
      badge.style.display   = total > 0 ? 'inline' : 'none';
      document.getElementById('notifDot').style.display = total > 0 ? 'block' : 'none';

      const tbody = document.getElementById('tablaSolicitudes');
      if (total === 0) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fa-regular fa-clipboard"></i>No hay solicitudes pendientes</div></td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const hora = (d.hora_inicio && d.hora_fin) ? `${d.hora_inicio} – ${d.hora_fin}` : '—';
        tbody.innerHTML += `
          <tr>
            <td><strong>${d.nombre_solicitante || '—'}</strong><br>
                <span style="font-size:.68rem;color:var(--text-light)">${d.rol || ''}</span></td>
            <td>${d.aula || '—'}</td>
            <td>${hora}</td>
            <td><span class="status-chip chip-pending">⏳ Pendiente</span></td>
            <td><div class="action-btns">
              <button class="btn-sm btn-approve" onclick="responderSol(this,'${doc.id}','aprobada')">✓ Aprobar</button>
              <button class="btn-sm btn-reject"  onclick="responderSol(this,'${doc.id}','rechazada')">✗ Rechazar</button>
            </div></td>
          </tr>`;
      });
    } catch(e) { console.error('Solicitudes:', e); }
  }

  async function responderSol(btn, docId, nuevoEstado) {
    try {
      await db.collection('solicitudes').doc(docId).update({
        estado: nuevoEstado,
        fecha_respuesta: firebase.firestore.FieldValue.serverTimestamp()
      });
      const fila = btn.closest('tr');
      const chip = fila.querySelector('.status-chip');
      if (nuevoEstado === 'aprobada') {
        chip.className = 'status-chip chip-approved';
        chip.textContent = '✓ Aprobada';
        showToast('Solicitud aprobada', 'success');
      } else {
        chip.className = 'status-chip chip-rejected';
        chip.textContent = '✗ Rechazada';
        showToast('Solicitud rechazada', 'error');
      }
      fila.querySelector('.action-btns').innerHTML = '';
      // Registrar en historial
      await db.collection('historial_eventos').add({
        tipo: 'solicitud',
        titulo: `Solicitud ${nuevoEstado}`,
        descripcion: `Solicitud de ${fila.cells[0].querySelector('strong').textContent} — ${fila.cells[1].textContent}`,
        fecha: firebase.firestore.FieldValue.serverTimestamp()
      });
      // Actualizar contador
      const pendientes = document.querySelectorAll('.chip-pending').length;
      document.getElementById('kpiSolicitudes').textContent = pendientes;
      document.getElementById('badgeSol').textContent = `${pendientes} pendiente${pendientes !== 1 ? 's' : ''}`;
      document.getElementById('navBadgeSol').textContent = pendientes;
      document.getElementById('navBadgeSol').style.display = pendientes > 0 ? 'inline' : 'none';
    } catch(e) {
      showToast('Error al actualizar la solicitud', 'error');
    }
  }

  async function cargarActividad() {
    try {
      const snap = await db.collection('historial_eventos')
        .orderBy('fecha', 'desc').limit(5).get();
      const list = document.getElementById('activityList');
      if (snap.empty) {
        list.innerHTML = `<div class="empty-state"><i class="fa-regular fa-clock"></i>Sin actividad reciente</div>`;
        return;
      }
      const iconMap = {
        'encendido': { cls:'act-on',   ico:'fa-power-off' },
        'apagado':   { cls:'act-off',  ico:'fa-power-off' },
        'solicitud': { cls:'act-req',  ico:'fa-clipboard-list' },
        'usuario':   { cls:'act-user', ico:'fa-user-plus' },
      };
      list.innerHTML = '';
      snap.forEach(doc => {
        const d  = doc.data();
        const ic = iconMap[d.tipo] || iconMap['solicitud'];
        const t  = d.fecha?.toDate ? d.fecha.toDate().toLocaleString('es-MX') : '';
        list.innerHTML += `
          <div class="activity-item">
            <div class="act-icon ${ic.cls}"><i class="fa-solid ${ic.ico}"></i></div>
            <div class="act-body">
              <div class="act-title">${d.titulo || '—'}</div>
              <div class="act-desc">${d.descripcion || ''}</div>
              <div class="act-time">${t}</div>
            </div>
          </div>`;
      });
    } catch(e) { console.error('Actividad:', e); }
  }

  async function cargarConsumoSemanal() {
    const dias = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date(); d.setDate(d.getDate() - i); dias.push(d);
    }
    let datos = new Array(7).fill(0);
    try {
      const inicio = new Date(); inicio.setDate(inicio.getDate() - 6); inicio.setHours(0,0,0,0);
      const snap = await db.collection('historial_consumo').where('fecha', '>=', inicio).get();
      snap.forEach(doc => {
        const d = doc.data();
        const f = d.fecha?.toDate ? d.fecha.toDate() : new Date(d.fecha);
        for (let i = 0; i < 7; i++) {
          if (f.toDateString() === dias[i].toDateString()) datos[i] += d.kwh || 0;
        }
      });
    } catch(e) { /* sin datos aún */ }
    const max = Math.max(...datos);
    barChart.data.datasets[0].data = datos;
    barChart.data.datasets[0].backgroundColor = datos.map(v => v === max && max > 0 ? '#1A75FF' : '#C5D8FF');
    barChart.update();
  }

  function showToast(msg, type = 'info') {
    const icons = { success:'circle-check', error:'circle-xmark', info:'circle-info' };
    const wrap = document.getElementById('toastWrap');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fa-solid fa-${icons[type]}"></i> ${msg}`;
    wrap.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }
</script>

  <!-- Preloader dismiss -->
  <script>
    (function(){
      var el = document.getElementById('simgeca-preloader');
      if(!el) return;
      function dismiss(){ el.classList.add('fade-out'); setTimeout(function(){ el.remove(); }, 550); }
      if(document.readyState === 'complete'){ setTimeout(dismiss, 400); }
      else { window.addEventListener('load', function(){ setTimeout(dismiss, 400); }); }
    })();
  </script>

</body>
</html>
