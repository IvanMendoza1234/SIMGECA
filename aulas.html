<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIMGECA — Aulas y Turnos</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --azul:       #003B8E;
      --azul-mid:   #0057CC;
      --azul-light: #1A75FF;
      --azul-pale:  #E8F0FE;
      --accent:     #00C2A8;
      --danger:     #EF4444;
      --success:    #10B981;
      --warning:    #F59E0B;
      --bg:         #F0F4FA;
      --surface:    #FFFFFF;
      --surface2:   #F8FAFF;
      --text:       #0D1B3E;
      --text-mid:   #3D5280;
      --text-light: #7A90B8;
      --border:     #DDE5F4;
      --sidebar-w:  265px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }

    /* ══ SIDEBAR ══ */
    .sidebar { width: var(--sidebar-w); background: var(--azul); min-height: 100vh; display: flex; flex-direction: column; position: fixed; top: 0; left: 0; z-index: 100; }
    .sidebar-logo { padding: 1.5rem 1.25rem 1.1rem; border-bottom: 1px solid rgba(255,255,255,.08); }
    .logo-row { display: flex; align-items: center; gap: .7rem; }
    .logo-icon { width: 38px; height: 38px; background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.18); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--accent); }
    .logo-text { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: -.5px; }
    .logo-sub  { font-size: .62rem; color: rgba(255,255,255,.35); margin-top: .1rem; }
    .sidebar-nav { flex: 1; padding: .75rem 0; overflow-y: auto; }
    .nav-section { font-size: .6rem; font-weight: 700; color: rgba(255,255,255,.28); text-transform: uppercase; letter-spacing: .1em; padding: .85rem 1.25rem .3rem; }
    .nav-item { display: flex; align-items: center; gap: .7rem; padding: .65rem 1.25rem; color: rgba(255,255,255,.55); font-size: .85rem; font-weight: 500; cursor: pointer; transition: all .2s; border-left: 3px solid transparent; text-decoration: none; }
    .nav-item:hover { background: rgba(255,255,255,.06); color: rgba(255,255,255,.9); }
    .nav-item.active { background: rgba(255,255,255,.1); color: #fff; border-left-color: var(--accent); }
    .nav-item i { width: 17px; text-align: center; font-size: .9rem; }
    .nav-badge { margin-left: auto; background: var(--danger); color: #fff; font-size: .62rem; font-weight: 700; padding: .12rem .42rem; border-radius: 20px; display:none; }
    .sidebar-footer { padding: .9rem 1.25rem; border-top: 1px solid rgba(255,255,255,.08); }
    .user-card { display: flex; align-items: center; gap: .65rem; }
    .user-avatar { width: 34px; height: 34px; background: var(--accent); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: .85rem; color: #fff; font-weight: 700; flex-shrink: 0; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: .8rem; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: .68rem; color: rgba(255,255,255,.38); }
    .btn-logout { background: none; border: none; cursor: pointer; color: rgba(255,255,255,.35); font-size: .88rem; padding: .25rem; border-radius: 6px; transition: color .2s; }
    .btn-logout:hover { color: var(--danger); }

    /* ══ MAIN ══ */
    .main { margin-left: var(--sidebar-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: .9rem 1.75rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
    .topbar-left h1 { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--text); }
    .topbar-left p  { font-size: .75rem; color: var(--text-light); margin-top: .05rem; }
    .topbar-right   { display: flex; align-items: center; gap: .6rem; }
    .btn-primary { display: flex; align-items: center; gap: .5rem; padding: .55rem 1.1rem; background: var(--azul); color: #fff; border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; cursor: pointer; transition: background .2s; }
    .btn-primary:hover { background: var(--azul-mid); }

    .page-content { padding: 1.5rem 1.75rem; flex: 1; }

    /* ══ TABS ══ */
    .tabs { display: flex; gap: .35rem; margin-bottom: 1.25rem; background: var(--surface); border: 1.5px solid var(--border); border-radius: 11px; padding: .3rem; width: fit-content; }
    .tab { padding: .45rem 1.1rem; border-radius: 8px; font-size: .83rem; font-weight: 600; cursor: pointer; color: var(--text-light); transition: all .2s; border: none; background: none; font-family: 'DM Sans', sans-serif; }
    .tab.active { background: var(--azul); color: #fff; }
    .tab:hover:not(.active) { background: var(--azul-pale); color: var(--azul); }

    /* ══ TOOLBAR ══ */
    .toolbar { display: flex; align-items: center; gap: .75rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .search-wrap { position: relative; flex: 1; min-width: 220px; max-width: 340px; }
    .search-wrap i { position: absolute; left: 11px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: .85rem; pointer-events: none; }
    .search-input { width: 100%; padding: .6rem 1rem .6rem 2.35rem; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface); font-family: 'DM Sans', sans-serif; font-size: .85rem; color: var(--text); outline: none; transition: border-color .2s; }
    .search-input:focus { border-color: var(--azul-light); }
    .filter-select { padding: .6rem .9rem; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface); font-family: 'DM Sans', sans-serif; font-size: .83rem; color: var(--text-mid); outline: none; cursor: pointer; }
    .count-badge { margin-left: auto; font-size: .78rem; color: var(--text-light); font-weight: 500; }

    /* ══ GRID AULAS ══ */
    .aula-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }

    .aula-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      transition: box-shadow .2s, transform .2s;
      animation: fadeIn .3s ease both;
    }
    .aula-card:hover { box-shadow: 0 6px 24px rgba(0,59,142,.09); transform: translateY(-1px); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

    /* Barra de color por turno */
    .aula-card-bar { height: 4px; }
    .bar-matutino  { background: linear-gradient(90deg, #1A75FF, #00C2A8); }
    .bar-vespertino{ background: linear-gradient(90deg, #F59E0B, #FF6B35); }
    .bar-ambos     { background: linear-gradient(90deg, #1A75FF, #F59E0B); }
    .bar-sin       { background: var(--border); }

    .aula-card-body { padding: 1.1rem; }
    .aula-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: .85rem; }
    .aula-icon { width: 44px; height: 44px; border-radius: 12px; background: var(--azul-pale); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--azul-light); flex-shrink: 0; }
    .turno-badge { font-size: .7rem; font-weight: 700; padding: .22rem .6rem; border-radius: 6px; }
    .turno-matutino  { background: #EEF3FF; color: var(--azul); }
    .turno-vespertino{ background: #FEF3C7; color: #92400E; }
    .turno-ambos     { background: #F0FDF4; color: #166534; }
    .turno-sin       { background: var(--surface2); color: var(--text-light); }

    .aula-nombre { font-family: 'Syne', sans-serif; font-size: 1.05rem; font-weight: 700; color: var(--text); margin-bottom: .12rem; }
    .aula-tipo   { font-size: .76rem; color: var(--text-light); margin-bottom: .9rem; }

    .aula-info { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem .75rem; margin-bottom: .9rem; }
    .info-item-lbl { font-size: .67rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .05em; }
    .info-item-val { font-size: .82rem; font-weight: 600; color: var(--text-mid); margin-top: .06rem; }

    /* Horario chips */
    .horario-row { margin-bottom: .9rem; }
    .horario-title { font-size: .67rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .05em; margin-bottom: .4rem; }
    .horario-chips { display: flex; flex-wrap: wrap; gap: .3rem; }
    .horario-chip { font-size: .7rem; font-weight: 600; padding: .2rem .55rem; border-radius: 6px; background: var(--surface2); color: var(--text-mid); border: 1px solid var(--border); }
    .horario-chip.mat { background: #EEF3FF; color: var(--azul); border-color: #C5D8FF; }
    .horario-chip.ves { background: #FEF3C7; color: #92400E; border-color: #FDE68A; }

    /* AC asignado */
    .ac-asignado { display: flex; align-items: center; gap: .5rem; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: .5rem .75rem; margin-bottom: .85rem; font-size: .78rem; color: var(--text-mid); }
    .ac-asignado i { color: var(--azul-light); }
    .ac-asignado strong { color: var(--text); }
    .ac-estado-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: auto; flex-shrink: 0; }
    .dot-encendido { background: var(--success); }
    .dot-apagado   { background: var(--border); }
    .dot-mant      { background: var(--warning); }

    .aula-footer { display: flex; gap: .4rem; padding-top: .75rem; border-top: 1px solid var(--border); }
    .btn-icon { display: flex; align-items: center; gap: .35rem; padding: .38rem .75rem; border-radius: 7px; font-size: .75rem; font-weight: 600; border: 1.5px solid var(--border); background: var(--surface); color: var(--text-mid); cursor: pointer; transition: all .15s; font-family: 'DM Sans', sans-serif; }
    .btn-icon:hover { border-color: var(--azul-light); color: var(--azul); background: var(--azul-pale); }
    .btn-icon.danger:hover { border-color: var(--danger); color: var(--danger); background: #FFF5F5; }
    .btn-icon.ml-auto { margin-left: auto; }

    /* Empty state */
    .empty-state { text-align: center; padding: 4rem 1rem; color: var(--text-light); }
    .empty-state i { font-size: 2.5rem; margin-bottom: .75rem; display: block; opacity: .3; }
    .empty-state h3 { font-family: 'Syne', sans-serif; font-size: 1.1rem; color: var(--text-mid); margin-bottom: .4rem; }
    .empty-state p { font-size: .83rem; }

    /* ══ MODAL ══ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(13,27,62,.45); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border-radius: 18px; width: 100%; max-width: 580px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,.2); animation: modalIn .25s ease; }
    @keyframes modalIn { from { opacity:0; transform:scale(.96) translateY(12px); } to { opacity:1; transform:none; } }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-family: 'Syne', sans-serif; font-size: 1.05rem; font-weight: 700; color: var(--text); }
    .modal-close { width: 32px; height: 32px; border: none; background: var(--surface2); border-radius: 8px; cursor: pointer; color: var(--text-light); font-size: .9rem; display: flex; align-items: center; justify-content: center; transition: all .15s; }
    .modal-close:hover { background: #FEE2E2; color: var(--danger); }
    .modal-body { padding: 1.25rem 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: .6rem; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .9rem; }
    .form-grid .full { grid-column: 1 / -1; }
    .form-group { display: flex; flex-direction: column; gap: .35rem; }
    .form-label { font-size: .76rem; font-weight: 700; color: var(--text-mid); letter-spacing: .02em; }
    .form-input, .form-select, .form-textarea { padding: .65rem .9rem; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface2); font-family: 'DM Sans', sans-serif; font-size: .875rem; color: var(--text); outline: none; transition: border-color .2s, box-shadow .2s; }
    .form-input:focus, .form-select:focus { border-color: var(--azul-light); box-shadow: 0 0 0 3px rgba(26,117,255,.1); background: #fff; }
    .form-input.error { border-color: var(--danger); }
    .form-hint { font-size: .7rem; color: var(--text-light); }
    .section-label { font-size: .72rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .08em; margin: .75rem 0 .5rem; padding-bottom: .4rem; border-bottom: 1px solid var(--border); grid-column: 1 / -1; }

    /* Horario visual en modal */
    .horario-tabla { grid-column: 1 / -1; width: 100%; border-collapse: collapse; font-size: .78rem; margin-top: .25rem; }
    .horario-tabla th { text-align: left; padding: .45rem .6rem; font-size: .68rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .05em; border-bottom: 1.5px solid var(--border); }
    .horario-tabla td { padding: .5rem .6rem; border-bottom: 1px solid var(--border); color: var(--text-mid); }
    .horario-tabla tr:last-child td { border-bottom: none; }
    .horario-tabla .dia { font-weight: 600; color: var(--text); }
    .hor-mat { color: var(--azul); font-weight: 600; }
    .hor-ves { color: #92400E; font-weight: 600; }
    .hor-na  { color: var(--border); }

    .btn-cancel { padding: .55rem 1.1rem; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; color: var(--text-mid); cursor: pointer; }
    .btn-save { display: flex; align-items: center; gap: .45rem; padding: .55rem 1.25rem; background: var(--azul); border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; color: #fff; cursor: pointer; transition: background .2s; }
    .btn-save:hover { background: var(--azul-mid); }
    .btn-save:disabled { opacity: .6; cursor: not-allowed; }
    .btn-danger-full { padding: .55rem 1.1rem; background: #FEE2E2; border: 1.5px solid #FECACA; border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .85rem; font-weight: 600; color: #991B1B; cursor: pointer; }
    .btn-danger-full:hover { background: #FECACA; }

    /* Modal confirmar */
    .modal-confirm .modal { max-width: 400px; }
    .confirm-icon { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin: 0 auto 1rem; }
    .confirm-icon.danger { background: #FEE2E2; color: var(--danger); }
    .modal-body.center { text-align: center; }
    .confirm-title { font-family: 'Syne', sans-serif; font-size: 1.05rem; font-weight: 700; color: var(--text); margin-bottom: .5rem; }
    .confirm-desc  { font-size: .84rem; color: var(--text-light); line-height: 1.5; }

    /* Toast */
    .toast-wrap { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; display: flex; flex-direction: column; gap: .5rem; }
    .toast { padding: .7rem 1.1rem; border-radius: 10px; font-size: .8rem; font-weight: 500; display: flex; align-items: center; gap: .55rem; color: #fff; box-shadow: 0 8px 24px rgba(0,0,0,.18); animation: fadeIn .3s ease; max-width: 280px; }
    .toast.success { background: var(--success); }
    .toast.error   { background: var(--danger); }
    .toast.info    { background: var(--azul); }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .form-grid .full { grid-column: 1; }
      .aula-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- ══ SIDEBAR ══ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-row">
      <div class="logo-icon"><i class="fa-solid fa-wind"></i></div>
      <div>
        <div class="logo-text">SIMGECA</div>
        <div class="logo-sub">TecNM — Lázaro Cárdenas</div>
      </div>
    </div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">Principal</div>
    <a class="nav-item" href="dashboard.html"><i class="fa-solid fa-house"></i> Inicio</a>
    <div class="nav-section">Gestión</div>
    <a class="nav-item" href="acs.html"><i class="fa-solid fa-snowflake"></i> Aires Acondicionados</a>
    <a class="nav-item active" href="aulas.html"><i class="fa-solid fa-school"></i> Aulas y Turnos</a>
    <a class="nav-item" href="usuarios.html"><i class="fa-solid fa-users"></i> Usuarios</a>
    <a class="nav-item" href="solicitudes.html"><i class="fa-solid fa-clipboard-list"></i> Solicitudes
      <span class="nav-badge" id="navBadgeSol">0</span></a>
    <div class="nav-section">Análisis</div>
    <a class="nav-item" href="monitoreo.html"><i class="fa-solid fa-chart-line"></i> Monitoreo</a>
    <a class="nav-item" href="reportes.html"><i class="fa-solid fa-triangle-exclamation"></i> Reportes</a>
    <div class="nav-section">Sistema</div>
    <a class="nav-item" href="programacion.html"><i class="fa-solid fa-calendar-check"></i> Programación AC</a>
    <a class="nav-item" href="sistema.html"><i class="fa-solid fa-circle-info"></i> Acerca del sistema</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar" id="userAvatar">A</div>
      <div class="user-info">
        <div class="user-name" id="userName">Administrador</div>
        <div class="user-role">Admin del sistema</div>
      </div>
      <button class="btn-logout" onclick="doLogout()" title="Cerrar sesión">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </div>
</aside>

<!-- ══ MAIN ══ -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <h1>Aulas y Turnos</h1>
      <p>Administración de aulas y horarios institucionales</p>
    </div>
    <div class="topbar-right">
      <button class="btn-primary" onclick="abrirModalRegistro()">
        <i class="fa-solid fa-plus"></i> Registrar Aula
      </button>
    </div>
  </header>

  <div class="page-content">

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="cambiarTab('matutino', this)">
        <i class="fa-solid fa-sun"></i> Matutino <span id="countMat" style="opacity:.6"></span>
      </button>
      <button class="tab" onclick="cambiarTab('vespertino', this)">
        <i class="fa-solid fa-cloud-sun"></i> Vespertino <span id="countVes" style="opacity:.6"></span>
      </button>
      <button class="tab" onclick="cambiarTab('todos', this)">
        <i class="fa-solid fa-table-cells"></i> Todas <span id="countTodos" style="opacity:.6"></span>
      </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-wrap">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Buscar aula, docente o grupo..." oninput="filtrar()"/>
      </div>
      <select class="filter-select" id="filtroTipo" onchange="filtrar()">
        <option value="">Todos los tipos</option>
        <option value="Aula">Aula</option>
        <option value="Laboratorio">Laboratorio</option>
        <option value="Taller">Taller</option>
        <option value="Sala">Sala</option>
      </select>
      <span class="count-badge" id="countLabel">Cargando...</span>
    </div>

    <!-- Grid -->
    <div class="aula-grid" id="aulaGrid">
      <div class="empty-state" style="grid-column:1/-1">
        <i class="fa-solid fa-school"></i>
        <h3>Cargando aulas...</h3>
      </div>
    </div>

  </div>
</div>

<!-- ══ MODAL REGISTRO / EDICIÓN ══ -->
<div class="modal-overlay" id="modalRegistro">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitulo">Registrar Aula</span>
      <button class="modal-close" onclick="cerrarModal('modalRegistro')"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-grid">

        <div class="section-label">Información del aula</div>

        <div class="form-group full">
          <label class="form-label">Nombre del aula *</label>
          <input type="text" class="form-input" id="fNombre" placeholder="Ej: Aula 204, Lab. Cómputo 1..."/>
        </div>
        <div class="form-group">
          <label class="form-label">Tipo de espacio *</label>
          <select class="form-select" id="fTipo">
            <option value="">Selecciona...</option>
            <option value="Aula">Aula</option>
            <option value="Laboratorio">Laboratorio</option>
            <option value="Taller">Taller</option>
            <option value="Sala">Sala</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Capacidad (alumnos)</label>
          <input type="number" class="form-input" id="fCapacidad" placeholder="Ej: 30" min="1" max="200"/>
        </div>
        <div class="form-group">
          <label class="form-label">Edificio / Bloque</label>
          <input type="text" class="form-input" id="fEdificio" placeholder="Ej: Edificio A, Bloque 2..."/>
        </div>
        <div class="form-group">
          <label class="form-label">Piso / Nivel</label>
          <input type="text" class="form-input" id="fPiso" placeholder="Ej: Planta baja, 2do piso"/>
        </div>

        <div class="section-label">Asignación de turno</div>

        <div class="form-group full">
          <label class="form-label">Turno institucional</label>
          <select class="form-select" id="fTurno" onchange="actualizarHorarioPreview()">
            <option value="">Sin turno definido</option>
            <option value="matutino">Matutino</option>
            <option value="vespertino">Vespertino</option>
            <option value="ambos">Ambos turnos</option>
          </select>
          <span class="form-hint">El turno determina en qué horario el AC se enciende automáticamente.</span>
        </div>

        <!-- Tabla de horarios -->
        <div class="section-label">Horario institucional vigente</div>
        <table class="horario-tabla" id="horarioPreview">
          <thead>
            <tr><th>Día</th><th>Matutino</th><th>Vespertino</th></tr>
          </thead>
          <tbody>
            <tr><td class="dia">Lunes</td>     <td class="hor-mat">7:00 – 13:00</td><td class="hor-ves">14:00 – 20:00</td></tr>
            <tr><td class="dia">Martes</td>    <td class="hor-mat">7:00 – 13:00</td><td class="hor-ves">14:00 – 20:00</td></tr>
            <tr><td class="dia">Miércoles</td> <td class="hor-mat">9:00 – 13:00</td><td class="hor-ves">14:00 – 20:00</td></tr>
            <tr><td class="dia">Jueves</td>    <td class="hor-mat">7:00 – 13:00</td><td class="hor-ves">14:00 – 20:00</td></tr>
            <tr><td class="dia">Viernes</td>   <td class="hor-mat">7:00 – 13:00</td><td class="hor-ves">16:00 – 20:00</td></tr>
            <tr><td class="dia">Sábado</td>    <td class="hor-mat">8:00 – 13:00</td><td class="hor-na">—</td></tr>
            <tr><td class="dia">Domingo</td>   <td class="hor-na">—</td>           <td class="hor-na">—</td></tr>
          </tbody>
        </table>

        <div class="section-label">Docente y grupo asignado</div>

        <div class="form-group">
          <label class="form-label">Docente asignado</label>
          <select class="form-select" id="fDocente">
            <option value="">Sin docente asignado</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Grupo / Materia</label>
          <input type="text" class="form-input" id="fGrupo" placeholder="Ej: ISC-6A, Cálculo..."/>
        </div>

        <div class="section-label">Equipo AC asignado</div>

        <div class="form-group full">
          <label class="form-label">Aire acondicionado del aula</label>
          <select class="form-select" id="fAC">
            <option value="">Sin AC asignado</option>
          </select>
          <span class="form-hint">Los ACs disponibles son los que aún no tienen aula asignada o están en esta aula.</span>
        </div>

        <div class="section-label">Observaciones</div>
        <div class="form-group full">
          <textarea class="form-input form-textarea" id="fObservaciones" placeholder="Notas sobre el aula..." style="resize:vertical;min-height:70px"></textarea>
        </div>

      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="cerrarModal('modalRegistro')">Cancelar</button>
      <button class="btn-save" id="btnGuardar" onclick="guardarAula()">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>
    </div>
  </div>
</div>

<!-- ══ MODAL CONFIRMAR ELIMINAR ══ -->
<div class="modal-overlay modal-confirm" id="modalEliminar">
  <div class="modal">
    <div class="modal-body center" style="padding:2rem 1.5rem">
      <div class="confirm-icon danger"><i class="fa-solid fa-trash"></i></div>
      <div class="confirm-title">¿Eliminar esta aula?</div>
      <p class="confirm-desc">Se eliminará permanentemente del sistema. Esta acción <strong>no se puede deshacer</strong>.</p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="cerrarModal('modalEliminar')">Cancelar</button>
      <button class="btn-danger-full" onclick="confirmarEliminar()">
        <i class="fa-solid fa-trash"></i> Eliminar
      </button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCdbaYB4Ke0buAMFhlr4YzsJUo_uYgj3Hg",
    authDomain: "simgeca-26297.firebaseapp.com",
    projectId: "simgeca-26297",
    storageBucket: "simgeca-26297.firebasestorage.app",
    messagingSenderId: "28195458236",
    appId: "1:28195458236:web:9250f82b845665d82cd4b9"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ── Protección de ruta ──
  auth.onAuthStateChanged(user => {
    if (!user) { window.location.href = 'login.html'; return; }
    document.getElementById('userName').textContent   = user.email.split('@')[0];
    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
    cargarBadgeSolicitudes();
    cargarDocentes();
    cargarACsDisponibles();
    cargarAulas();
  });

  function doLogout() { auth.signOut().then(() => window.location.href = 'login.html'); }

  // Estado global
  let todasAulas  = [];
  let todosACs    = [];
  let tabActual   = 'matutino';
  let docIdEditar = null;
  let docIdAccion = null;

  // ── Badge solicitudes ──
  async function cargarBadgeSolicitudes() {
    try {
      const snap = await db.collection('solicitudes').where('estado','==','pendiente').get();
      const b = document.getElementById('navBadgeSol');
      b.textContent   = snap.size;
      b.style.display = snap.size > 0 ? 'inline' : 'none';
    } catch(e) {}
  }

  // ── Cargar docentes para el select ──
  async function cargarDocentes() {
    try {
      const snap = await db.collection('usuarios').where('rol','==','docente').orderBy('nombre').get();
      const sel = document.getElementById('fDocente');
      sel.innerHTML = '<option value="">Sin docente asignado</option>';
      snap.forEach(doc => {
        const op = document.createElement('option');
        op.value       = doc.id;
        op.textContent = doc.data().nombre || doc.data().email;
        sel.appendChild(op);
      });
    } catch(e) {}
  }

  // ── Cargar ACs disponibles para el select ──
  async function cargarACsDisponibles() {
    try {
      const snap = await db.collection('aires_acondicionados')
        .where('dado_de_baja','==',false).get();
      todosACs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const sel = document.getElementById('fAC');
      sel.innerHTML = '<option value="">Sin AC asignado</option>';
      todosACs.forEach(ac => {
        const op = document.createElement('option');
        op.value       = ac.id;
        op.textContent = `${ac.nombre} — ${ac.marca} ${ac.modelo}`;
        sel.appendChild(op);
      });
    } catch(e) {}
  }

  // ── Cargar aulas con listener en tiempo real ──
  function cargarAulas() {
    db.collection('aulas').orderBy('nombre').onSnapshot(snap => {
      todasAulas = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      actualizarContadores();
      filtrar();
    }, e => { console.error(e); renderGrid([]); });
  }

  function actualizarContadores() {
    document.getElementById('countMat').textContent   = `(${todasAulas.filter(a => a.turno === 'matutino' || a.turno === 'ambos').length})`;
    document.getElementById('countVes').textContent   = `(${todasAulas.filter(a => a.turno === 'vespertino' || a.turno === 'ambos').length})`;
    document.getElementById('countTodos').textContent = `(${todasAulas.length})`;
  }

  // ── Filtrar ──
  function filtrar() {
    const q    = document.getElementById('searchInput').value.toLowerCase();
    const tipo = document.getElementById('filtroTipo').value;

    let result = todasAulas.filter(a => {
      if (tabActual === 'matutino'   && a.turno !== 'matutino'   && a.turno !== 'ambos')   return false;
      if (tabActual === 'vespertino' && a.turno !== 'vespertino' && a.turno !== 'ambos')   return false;
      if (tipo && a.tipo !== tipo) return false;
      if (q) {
        const h = `${a.nombre} ${a.docente_nombre} ${a.grupo} ${a.tipo} ${a.edificio}`.toLowerCase();
        if (!h.includes(q)) return false;
      }
      return true;
    });

    document.getElementById('countLabel').textContent = `${result.length} aula${result.length !== 1 ? 's' : ''}`;
    renderGrid(result);
  }

  // ── Calcular estado AC por horario ──
  function calcularEstadoAC(turno) {
    const ahora = new Date();
    const dia   = ahora.getDay();
    const hhmm  = ahora.getHours() * 60 + ahora.getMinutes();
    const bloques = [];

    if ([1,2,4,5].includes(dia)) bloques.push({ t:'matutino',  ini:6*60+45,  fin:13*60 });
    if (dia === 3)                bloques.push({ t:'matutino',  ini:8*60+45,  fin:13*60 });
    if ([1,2,3,4].includes(dia)) bloques.push({ t:'vespertino',ini:13*60+45, fin:20*60 });
    if (dia === 5)                bloques.push({ t:'vespertino',ini:15*60+45, fin:20*60 });
    if (dia === 6)                bloques.push({ t:'matutino',  ini:7*60+45,  fin:13*60 });

    for (const b of bloques) {
      const match = !turno || turno === 'ambos' || turno === b.t;
      if (match && hhmm >= b.ini && hhmm < b.fin) return 'encendido';
    }
    return 'apagado';
  }

  // ── Render cards ──
  function renderGrid(lista) {
    const grid = document.getElementById('aulaGrid');
    if (lista.length === 0) {
      grid.innerHTML = `
        <div class="empty-state" style="grid-column:1/-1">
          <i class="fa-solid fa-school"></i>
          <h3>Sin aulas registradas</h3>
          <p>Haz clic en "Registrar Aula" para agregar la primera.</p>
        </div>`;
      return;
    }

    const turnoMap = {
      matutino:   { cls:'turno-matutino',   bar:'bar-matutino',   lbl:'Matutino' },
      vespertino: { cls:'turno-vespertino',  bar:'bar-vespertino', lbl:'Vespertino' },
      ambos:      { cls:'turno-ambos',       bar:'bar-ambos',      lbl:'Ambos turnos' },
      '':         { cls:'turno-sin',         bar:'bar-sin',        lbl:'Sin turno' },
    };

    // Horarios por tab para mostrar en card
    const horarioTexto = (a) => {
      const t = a.turno || '';
      const chips = [];
      if (t === 'matutino' || t === 'ambos') {
        chips.push(`<span class="horario-chip mat">Lun-Mar-Jue-Vie 7:00–13:00</span>`);
        chips.push(`<span class="horario-chip mat">Mié 9:00–13:00</span>`);
        chips.push(`<span class="horario-chip mat">Sáb 8:00–13:00</span>`);
      }
      if (t === 'vespertino' || t === 'ambos') {
        chips.push(`<span class="horario-chip ves">Lun-Jue 14:00–20:00</span>`);
        chips.push(`<span class="horario-chip ves">Vie 16:00–20:00</span>`);
      }
      return chips.length ? chips.join('') : '<span class="horario-chip">Sin horario asignado</span>';
    };

    // Buscar AC asignado al aula
    const getAcInfo = (aulaId, aulaNombre) => {
      const ac = todosACs.find(a => a.aula === aulaNombre || a.aula_id === aulaId);
      if (!ac) return `<div class="ac-asignado" style="color:var(--text-light)"><i class="fa-solid fa-circle-xmark" style="color:var(--border)"></i> Sin AC asignado</div>`;
      const mantenimiento = ac.estado === 'mantenimiento';
      const estadoAC = mantenimiento ? 'mant' : (calcularEstadoAC(ac.turno) === 'encendido' ? 'encendido' : 'apagado');
      const dotCls   = estadoAC === 'encendido' ? 'dot-encendido' : estadoAC === 'mant' ? 'dot-mant' : 'dot-apagado';
      const estadoLbl= estadoAC === 'encendido' ? 'Encendido' : estadoAC === 'mant' ? 'Mantenimiento' : 'Apagado';
      return `<div class="ac-asignado"><i class="fa-solid fa-snowflake"></i><strong>${ac.nombre}</strong> &nbsp;·&nbsp; ${ac.marca} ${ac.modelo}<div class="ac-estado-dot ${dotCls}" title="${estadoLbl}"></div></div>`;
    };

    grid.innerHTML = lista.map(a => {
      const tm = turnoMap[a.turno || ''] || turnoMap[''];
      return `
        <div class="aula-card">
          <div class="aula-card-bar ${tm.bar}"></div>
          <div class="aula-card-body">
            <div class="aula-header">
              <div class="aula-icon"><i class="fa-solid fa-door-open"></i></div>
              <span class="turno-badge ${tm.cls}">${tm.lbl}</span>
            </div>
            <div class="aula-nombre">${a.nombre}</div>
            <div class="aula-tipo">${a.tipo || '—'} ${a.edificio ? '· ' + a.edificio : ''} ${a.piso ? '· ' + a.piso : ''}</div>

            <div class="aula-info">
              <div>
                <div class="info-item-lbl">Capacidad</div>
                <div class="info-item-val">${a.capacidad ? a.capacidad + ' alumnos' : '—'}</div>
              </div>
              <div>
                <div class="info-item-lbl">Docente</div>
                <div class="info-item-val">${a.docente_nombre || '—'}</div>
              </div>
              <div style="grid-column:1/-1">
                <div class="info-item-lbl">Grupo / Materia</div>
                <div class="info-item-val">${a.grupo || '—'}</div>
              </div>
            </div>

            <div class="horario-row">
              <div class="horario-title">Horario de operación AC</div>
              <div class="horario-chips">${horarioTexto(a)}</div>
            </div>

            ${getAcInfo(a.id, a.nombre)}

            <div class="aula-footer">
              <button class="btn-icon" onclick="editarAula('${a.id}')">
                <i class="fa-solid fa-pen"></i> Editar
              </button>
              <button class="btn-icon danger ml-auto" onclick="pedirEliminar('${a.id}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // ── Tabs ──
  function cambiarTab(tab, el) {
    tabActual = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    filtrar();
  }

  // ── Modal registro ──
  function abrirModalRegistro() {
    docIdEditar = null;
    document.getElementById('modalTitulo').textContent = 'Registrar Aula';
    limpiarForm();
    document.getElementById('modalRegistro').classList.add('open');
  }

  function editarAula(id) {
    const a = todasAulas.find(x => x.id === id);
    if (!a) return;
    docIdEditar = id;
    document.getElementById('modalTitulo').textContent     = 'Editar Aula';
    document.getElementById('fNombre').value               = a.nombre        || '';
    document.getElementById('fTipo').value                 = a.tipo          || '';
    document.getElementById('fCapacidad').value            = a.capacidad     || '';
    document.getElementById('fEdificio').value             = a.edificio      || '';
    document.getElementById('fPiso').value                 = a.piso          || '';
    document.getElementById('fTurno').value                = a.turno         || '';
    document.getElementById('fDocente').value              = a.docente_id    || '';
    document.getElementById('fGrupo').value                = a.grupo         || '';
    document.getElementById('fAC').value                   = a.ac_id         || '';
    document.getElementById('fObservaciones').value        = a.observaciones  || '';
    document.getElementById('modalRegistro').classList.add('open');
  }

  function limpiarForm() {
    ['fNombre','fCapacidad','fEdificio','fPiso','fGrupo','fObservaciones'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('fTipo').value    = '';
    document.getElementById('fTurno').value   = '';
    document.getElementById('fDocente').value = '';
    document.getElementById('fAC').value      = '';
  }

  function actualizarHorarioPreview() {
    // La tabla de horario es informativa y siempre es la misma, no cambia
  }

  async function guardarAula() {
    const nombre = document.getElementById('fNombre').value.trim();
    const tipo   = document.getElementById('fTipo').value;
    if (!nombre || !tipo) {
      document.getElementById('fNombre').classList.toggle('error', !nombre);
      document.getElementById('fTipo').classList.toggle('error', !tipo);
      showToast('Completa los campos obligatorios', 'error');
      return;
    }

    // Obtener nombre del docente seleccionado
    const docenteSel  = document.getElementById('fDocente');
    const docenteNombre = docenteSel.options[docenteSel.selectedIndex]?.text || '';

    const datos = {
      nombre,
      tipo,
      capacidad:      Number(document.getElementById('fCapacidad').value) || 0,
      edificio:       document.getElementById('fEdificio').value.trim(),
      piso:           document.getElementById('fPiso').value.trim(),
      turno:          document.getElementById('fTurno').value,
      docente_id:     document.getElementById('fDocente').value,
      docente_nombre: docenteNombre === 'Sin docente asignado' ? '' : docenteNombre,
      grupo:          document.getElementById('fGrupo').value.trim(),
      ac_id:          document.getElementById('fAC').value,
      observaciones:  document.getElementById('fObservaciones').value.trim(),
    };

    const btn = document.getElementById('btnGuardar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';

    try {
      if (docIdEditar) {
        await db.collection('aulas').doc(docIdEditar).update(datos);
        showToast('Aula actualizada correctamente', 'success');
      } else {
        datos.fecha_registro = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('aulas').add(datos);
        // Si se asignó un AC, actualizar su campo de aula
        if (datos.ac_id) {
          await db.collection('aires_acondicionados').doc(datos.ac_id).update({ aula: datos.nombre });
        }
        showToast('Aula registrada correctamente', 'success');
      }
      cerrarModal('modalRegistro');
    } catch(e) {
      console.error(e);
      showToast('Error al guardar el aula', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
    }
  }

  // ── Eliminar ──
  function pedirEliminar(id) {
    docIdAccion = id;
    document.getElementById('modalEliminar').classList.add('open');
  }
  async function confirmarEliminar() {
    if (!docIdAccion) return;
    try {
      await db.collection('aulas').doc(docIdAccion).delete();
      showToast('Aula eliminada', 'error');
      cerrarModal('modalEliminar');
    } catch(e) { showToast('Error al eliminar', 'error'); }
  }

  // ── Helpers ──
  function cerrarModal(id) {
    document.getElementById(id).classList.remove('open');
    docIdAccion = null;
  }
  document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
  });

  function showToast(msg, type = 'info') {
    const icons = { success:'circle-check', error:'circle-xmark', info:'circle-info' };
    const wrap = document.getElementById('toastWrap');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fa-solid fa-${icons[type]}"></i> ${msg}`;
    wrap.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }
</script>
</body>
</html>
